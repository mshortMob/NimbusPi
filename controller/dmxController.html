<html>
    <head>
        <style>
            body {
                background-color: black;
                padding: 10px;
            }
            #sliderContainer{
                border:4px solid #555555;
                width:50%;
                height:93%;
                position:absolute;
                left:1%;
                top:2%;
            }
            #gridContainer {
                display: grid;
                position:absolute;
                width:46.5%;
                height:93%;
                left:52%;
                top:2%;
                grid-template-columns: auto auto auto auto;
                border:4px solid #555555;
            }
        </style>
    </head>
    <body>
        <div id="sliderContainer"></div>
        <div id="gridContainer"> </div>
    </body>
    <script>

        init();
        function init(){
            dataModel=[];
            isWriteMode=false;
            selectedScene=1;
            loadScene(1,true);
        }
        
        function loadScene(num, isInitialization){
            var xmlhttp=new XMLHttpRequest();
            xmlhttp.open("GET", "../controller/dmxControllerScenes/scene"+parseInt(num)+".txt?v="+parseInt(new Date().getTime()), true);
            xmlhttp.send();
            xmlhttp.onload = function(e){
                var temp=xmlhttp.response.split(",");
                for(var x=0; x<512; x++){
                    dataModel[x]=parseInt(temp[x]);
                }
                if(isInitialization==true){
                    createSliderElements();
                    createGrid();
                    initializeDMX();
                }else{
                    for(var x=1; x<9; x++){
                        document.getElementById("slider"+x).setValue(dataModel[x-1])
                    }
                }
            }
        }

        function saveScene(num){
            var requestBody=dataModel.toString();
            var xmlhttp=new XMLHttpRequest();
            xmlhttp.open("POST", "../php/write.php?fn=controller/dmxControllerScenes/scene"+parseInt(num)+".txt", true);
            xmlhttp.send(requestBody);
            xmlhttp.onload = function(e){console.log(xmlhttp.response.status)}
        }

        function createGrid(){
            for(var x=1; x<21; x++){
                var button=document.createElement('button');
                button.className="menuButton"
                button.id="button"+x
                button.num=x;
                button.innerHTML=parseInt(x-4);
                button.style.backgroundColor="#222222";
                button.style.border="1px solid #555555";
                button.style.color="#aaaaaa";
                document.getElementById("gridContainer").appendChild(button);
                if(x==1){
                    button.innerHTML="<";
                }
                if(x==2){
                    button.innerHTML="Misc";
                }
                if(x==3){
                    button.innerHTML="Write";
                }
                if(x==4){
                    button.innerHTML=">";
                }
                if(x==5){
                    button.style.backgroundColor="#777777";
                }
                if(x>=5){
                    button.onclick=function(){
                        selectedScene=this.num-4;
                        loadScene(this.num-4,false);
                        for(var x=5; x<21; x++){
                            document.getElementById("button"+x).style.backgroundColor="#222222";
                        }
                        this.style.backgroundColor="#777777"
                    }
                }else{
                    button.onmousedown=function(){
                        this.style.backgroundColor="#777777"
                        if(this.num==3){
                            console.log("Saving Scene: "+selectedScene);
                            saveScene(selectedScene);
                        }
                    }
                    button.onmouseup=function(){
                        this.style.backgroundColor="#222222"
                    }
                }
                if(x==1 || x==5 || x==9 || x==13 || x==17){
                    button.style.borderLeft="0px solid black"; 
                }
                if(x>16){
                    button.style.borderBottom="0px solid black"; 
                }
            }
        }

        function createSliderElements(){
            for(var x=1; x<9; x++){
                var canvas=document.createElement('canvas');
                canvas.className="slider"
                canvas.id="slider"+x
                canvas.num=x;
                canvas.currentChannel=x-1;
                canvas.style.backgroundColor="grey";
                canvas.style.width="11%";
                canvas.style.height="97%";
                canvas.style.margin=".75%";
                canvas.isSelected=false;
                canvas.onmouseup=function(event){
                    this.isSelected=false;
                }
                canvas.onmouseleave=function(event){
                    this.isSelected=false;
                }
                canvas.onmousedown=function(event){
                    this.isSelected=true;
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    ctx.fillStyle = "#222222";
                    ctx.fillRect(0, 0, this.width, event.offsetY/this.offsetHeight*this.height ); 
                    dataModel[this.currentChannel]=255-parseInt(event.offsetY/this.offsetHeight*255);
                }
                canvas.onmousemove=function(event){
                    if(this.isSelected){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(0, 0, this.width, event.offsetY/this.offsetHeight*this.height );  
                        dataModel[this.currentChannel]=255-parseInt(event.offsetY/this.offsetHeight*255);
                    }
                }
                canvas.setValue=function(value){
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    ctx.fillStyle = "#222222";
                    ctx.fillRect(0, 0, this.width, parseInt((255-value)/255*this.height) ); 
                    dataModel[this.currentChannel]=value;
                }
                canvas.setValue(dataModel[x-1]);
                document.getElementById("sliderContainer").appendChild(canvas);
            }
        }

        function writeDMX() {
            var xhttp = new XMLHttpRequest();
            xhttp.open("POST","../proxy/set_dmx", true);
            xhttp.setRequestHeader("accept", "*/*");
            xhttp.setRequestHeader("accept-language", "en-US,en;q=0.9,und;q=0.8");
            xhttp.setRequestHeader("cache-control", "no-cache");
            xhttp.setRequestHeader("content-type", "application/x-www-form-urlencoded;charset=UTF-8");
            xhttp.setRequestHeader("pragma", "no-cache" );

            dmxPayloadString="u=1&d="+dataModel.toString();
            // console.log(dmxPayloadString);
            xhttp.send(dmxPayloadString);

            xhttp.onload = function() {
                console.log("Sent DMX: "+this.responseText);
                setTimeout(function(){writeDMX();},250)
            };
        }	

        function initializeDMX(){
            xhttp = new XMLHttpRequest();
            xhttp.open("GET","../proxy/reload", true);
            xhttp.send();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    console.log("Initialize DMX: "+this.responseText);
                    writeDMX();
                }else{
                    console.log("DMX Not Available");
                }
            };
        }

    </script>
</html>