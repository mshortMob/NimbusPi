<html>
	<head>
		<title>ShaderMapper</title>
		<style>
			@media only screen and (min-width:1001px){
				body{
					margin:0px;
					background-color:black;
				}	
				canvas{
					opacity: 1;
					width:100%;
					height:100%;
					top:0px;
					left:0px;
					z-index:-2;
					transform:scale(1,1);
					position:fixed;
					float:left;
					object-fit:fill;
					/* cursor: none; */
				}
				.grid-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto auto auto auto auto auto auto;
					background-color: #777777;
					padding: 5px;
					width:47.5%;
					height:36.5%;
					top:5%;
					position:absolute;
				}
				.mask-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto;
					background-color: #777777;
					padding: 5px;
					width:47.5%;
					height:6%;
					top:42.8%;
					position:absolute;
				}
				.dmx-grid-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto auto;
					background-color: #777777;
					width:40.5%;
					height:32%;
					top:56%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					z-index: 5;
				}
				#dmxPageSelectorContainer{
					display: grid;
					grid-template-columns: auto;
					background-color: #777777;
					width:6.25%;
					height:32%;
					top:56%;
					left:92.75%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					z-index: 5;
				}
				.dmxPageSelectorButtons{
					background-color: black;
					color:white;
					font-size: .4em;
					border:1pt solid grey;
					border-top:1pt solid darkgrey;
					border-bottom:1pt solid darkgrey;
				}
				#dmx-overrides-container{
					z-index: 5;
					display: none;
					grid-template-columns: auto;
					background-color: grey;
					width:40.5%;
					height:31%;
					top:56.5%;
					left:51.75%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.dmx-overrides-controls{
					border:1.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: darkgrey;
				}
				.dmx-overrides-controls::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				#dmx-misc-container{
					z-index: 5;
					display: none;
					grid-template-columns: auto;
					background-color: grey;
					width:40.5%;
					height:31%;
					top:56.5%;
					left:51.75%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.dmxMiscButtons{
					background-color: darkgrey;
					font-size: .7em;
				}
				.dmxMiscButtons::active{
					background-color: lightgrey;
				}
				.presets-grid-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto auto auto;
					background-color: #777777;
					width:99.25%;
					height:9%;
					bottom:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					left:0%;
				}
				.mapping-controls-grid-container{
					display: grid;
					grid-template-columns: 10% 5% 5% 5% 5% 10% 10% 10% 10% 20% 10%;
					background-color: #777777;
					width:99.25%;
					height:9%;
					bottom:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					left:0%;
				}
				.mapping-controls-grid-container-top{
					display: grid;
					grid-template-columns: 20% 10% 10% 10% 10% 40%;
					background-color: #777777;
					width:96%;
					height:6.5%;
					top:0%;
					left:3.5%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.menu-grid-container{
						display: grid;
						grid-template-columns: auto;
						background-color: #777777;
						height:88%;
						width:3.5%;
						top:0%;
						left:0%;
						position:absolute;
						border:5px solid grey;
						margin:0px;
						padding:0px;
				}	
				.menu-grid-container-item{
					font-size: 0.5em;
				}
				.grid-item:hover{
					background-color: rgba(150, 150, 200, 0.8);
					border: 1px solid rgba(0, 0, 0, 0.8);
					padding: 20px;
					font-size: 14px;
					text-align: center;
				}
				#grid-container-A,#mask-container-A,#sectionLabelA,#sectionLabelC,.slider-container,.menu-page{
					left:3.75%;
				}
				#grid-container-B,#mask-container-B,#sectionLabelB,#sectionLabelD,.dmx-grid-container{
					left:51.75%;
				}
				.slider-container{
					background-color: darkgrey;
					width:47.5%;
					height:32%;
					top:56%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.customSlider {
					border:2.5px solid grey;
					-webkit-appearance: none;
					width:80%;
					left:20%;
					display:inline;
					height: 20%;
					position:absolute;
					outline: none;
					opacity: 1;
					-webkit-transition: .2s;
					transition: opacity .2s;
					margin:0px;
					padding:0px;
					background-color: darkgrey;
				}
				#zSlider{
					border:2.5px solid grey;
					-webkit-appearance: none;
					/* width:100%;
					left:0%; */
					position: relative;;
					/* display:inline; */
					/* height: 20%; */
					outline: none;
					opacity: 1;
					-webkit-transition: .2s;
					transition: opacity .2s;
					margin:0px;
					padding:0px;
					background-color: darkgrey;
				}
				.sliderLabel{
					border:2.5px solid grey;
					height:18%;
					width:20%;
					background-color: black;
					z-index: 0;
					text-align: center;
					position:absolute;
					color:white;
					margin:0;
					font-size:.5em;
				}
				.customSlider::-webkit-slider-thumb,.dmxOverrideSliders::-webkit-slider-thumb,#zSlider::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				.sectionLabel{
					background-color: black;
					display: grid;
					grid-template-columns: auto;
					width:47.5%;
					height:5%;
					position:absolute;
					border:5px solid grey;
					font-size:.88em;
				}
				button:focus{
					outline: none;
				}
				.menu-page{
					display:none;
					width:95.5%;
					height:87.75%;
					top:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					background-color: black;
				}
				#fm_page{
					background-color:grey;
					width:95.5%;
					height:89.25%;
					top:0%;
					left:3.75%;
					position:absolute;
					display:grid;
					grid-template-columns: 30% 70%;
					z-index: 0;
					border:5px solid grey;
					display: none;
				}
				.fm_controls{
					border:2.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: darkgrey;
				}
				.fm_controls::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				.fm_controls_slider_label{
					/* color:white; */
					border:2.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: #666666;				
				}
				.fm-scene-grid-container{
						display: none;
						grid-template-columns: auto auto auto auto auto;
						background-color: #777777;
						width:99.25%;
						height:9%;
						bottom:0%;
						position:absolute;
						border:5px solid grey;
						margin:0px;
						padding:0px;
						left:0%;
				}
				.fm-scene-grid-container-item{
					background-color: black;
					color:white;
					font-size: .5em;
				}
			}
			@media only screen and (max-width:1000px){
				body{
					margin:0px;
					background-color:black;
				}	
				canvas{
					opacity: 1;
					width:100%;
					height:100%;
					top:0px;
					left:0px;
					z-index:-2;
					transform:scale(1,1);
					position:fixed;
					float:left;
					object-fit:fill;
					/* cursor: none; */
				}
				.grid-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto auto auto auto auto auto auto;
					background-color:grey;
					padding: 5px;
					width:46.5%;
					height:36%;
					top:5.5%;
					position:absolute;
					z-index: 10;
				}
				#grid-container-A{
					width:45.5%;
					left:5.5%;
				}
				.mask-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto;
					background-color: #777777;
					padding: 5px;
					width:46.5%;
					height:6%;
					top:42.8%;
					position:absolute;
				}
				.dmx-grid-container{
					z-index: 5;
					display: grid;
					grid-template-columns: auto auto auto auto;
					background-color: #777777;
					width:32%;
					height:31%;
					top:56%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				#dmxPageSelectorContainer{
					display: grid;
					grid-template-columns: auto;
					background-color: #777777;
					width:13.875%;
					height:31%;
					top:56%;
					left:84.5%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					z-index: 5;
				}
				.dmxPageSelectorButtons{
					background-color: black;
					color:white;
					font-size: .4em;
					border:1pt solid grey;
					border-top:1pt solid grey;
					border-bottom:1pt solid grey;
				}
				#dmx-overrides-container{
					z-index: 5;
					display: none;
					grid-template-columns: auto;
					background-color: grey;
					width:32%;
					height:31%;
					top:56%;
					left:51.75%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.dmx-overrides-controls{
					border:1.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: darkgrey;
				}
				.dmx-overrides-controls::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				#dmx-misc-container{
					z-index: 5;
					display: none;
					grid-template-columns: auto;
					background-color: grey;
					width:32%;
					height:31%;
					top:56%;
					left:51.75%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.dmxMiscButtons{
					background-color: darkgrey;
					font-size: .4em;
					border:1px solid black;
				}
				.dmxMiscButtons:active{
					background-color: lightgrey;
				}
				.presets-grid-container{
					display: grid;
					grid-template-columns: auto auto auto auto auto auto auto auto auto;
					background-color: #777777;
					width:98.75%;
					height:9%;
					bottom:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					left:0%;
				}
				.mapping-controls-grid-container{
					display: grid;
					grid-template-columns: 10% 5% 5% 5% 5% 10% 10% 10% 10% 20% 10%;
					background-color: #777777;
					width:98.75%;
					height:9%;
					bottom:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					left:0%;
				}
				.mapping-controls-grid-container-top{
					display: grid;
					grid-template-columns: 20% 10% 10% 10% 10% 40%;
					background-color: #777777;
					width:94%;
					height:6.5%;
					top:0%;
					left:5%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.menu-grid-container{
						display: grid;
						grid-template-columns: auto;
						background-color: grey;
						height:87.25%;
						width:4.75%;
						top:0%;
						left:0%;
						position:absolute;
						border:5px solid grey;
						margin:0px;
						padding:0px;
				}	
				.menu-grid-container-item{
					font-size: 0.4em;
					border:1px solid grey;
				}
				#Misc_Button{
					font-size: 0.1em;
				}
				.grid-item:hover{
					background-color: rgba(150, 150, 200, 0.8);
					border: 1px solid rgba(0, 0, 0, 0.8);
					padding: 20px;
					font-size: 14px;
					text-align: center;
				}
				#mask-container-A,#sectionLabelA,#sectionLabelC,.slider-container,.menu-page{
					left:5%;
				}
				#grid-container-B,#mask-container-B,#sectionLabelB,#sectionLabelD,.dmx-grid-container{
					left:51.75%;
				}
				.slider-container{
					background-color: darkgrey;
					width:47.5%;
					height:31.75%;
					top:56%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
				}
				.customSlider {
					border:2.5px solid grey;
					-webkit-appearance: none;
					width: 80%;
					left:20%;
					display:inline;
					height: 20%;
					position:absolute;
					outline: none;
					opacity: 1;
					-webkit-transition: .2s;
					transition: opacity .2s;
					margin:0px;
					padding:0px;
					background-color: darkgrey;
				}
				#zSlider{
					border:2.5px solid grey;
					-webkit-appearance: none;
					/* width:100%;
					left:0%; */
					position: relative;;
					/* display:inline; */
					/* height: 20%; */
					outline: none;
					opacity: 1;
					-webkit-transition: .2s;
					transition: opacity .2s;
					margin:0px;
					padding:0px;
					background-color: darkgrey;
				}
				.sliderLabel{
					border:2.5px solid grey;
					height:17%;
					width:20%;
					background-color: black;
					z-index: 0;
					text-align: center;
					position:absolute;
					color:white;
					margin:0;
					font-size:.35em;
					z-index: 10;
				}
				.customSlider::-webkit-slider-thumb,.dmxOverrideSliders::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				#zSlider::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 18px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				.sectionLabel{
					background-color: black;
					display: grid;
					grid-template-columns: auto;
					width:46.5%;
					height:5%;
					position:absolute;
					border:5px solid grey;
					font-size:.6em;
				}
				button:focus{
					outline: none;
				}
				.menu-page{
					display:none;
					width:93.5%;
					height:87.75%;
					top:0%;
					position:absolute;
					border:5px solid grey;
					margin:0px;
					padding:0px;
					background-color: black;
				}
				#fm_page{
					background-color:grey;
					width:93.75%;
					height:87.25%;
					top:0%;
					left:5.25%;
					position:absolute;
					display:grid;
					grid-template-columns: 30% 70%;
					z-index: 1;
					border:5px solid grey;
					display: none;
				}
				.fm_controls{
					border:2.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: darkgrey;
				}
				.fm_controls::-webkit-slider-thumb{
					-webkit-appearance: none;
					appearance: none;
					width: 40px;
					height: 100%;
					background: slategray;
					cursor: pointer;
					border-left:1px solid darkslategray;
					border-right:1px solid darkslategray;
				}
				.fm_controls_slider_label{
					/* color:white; */
					border:2.5px solid grey;
					-webkit-appearance: none;
					outline: none;
					background-color: #666666;				
				}
				.fm-scene-grid-container{
						display: none;
						grid-template-columns: auto auto auto auto auto;
						width:98.75%;
						height:9%;
						bottom:0%;
						position:absolute;
						border:5px solid grey;
						margin:0px;
						padding:0px;
						left:0%;
						z-index: 1;
				}
				.fm-scene-grid-container-item{
					background-color: black;
					color:white;
					font-size: .5em;
					border:1pt solid grey;
					border-left:1pt solid grey;
					border-right:1pt solid grey;
				}
			}
		</style>
	</head>
	<body>
		<script src="../dependancies/three.js"></script>
		<script src="../dependancies/pixel8.js"></script>
		<script src="../dependancies/Detector.js"></script>
		<script src="../dependancies/NURBSSurface.js"></script>
		<script src="../dependancies/NURBSUtils.js"></script>
		<script src="../dependancies/TrackballControls.js"></script> 
		<div class="sectionLabel" id="sectionLabelA" style="top:0%" onclick="requestFullScreen();"><span style="position:absolute;top:15%;height:50%;color:white;left:45%; text-decoration: underline;">ShaderA</span></div>
		<div class="sectionLabel" id="sectionLabelB" style="top:0%" onclick="requestFullScreen();"><span style="position:absolute;top:15%;height:50%;color:white;left:45%; text-decoration: underline;">ShaderB</span></div>
		<div class="grid-container" id="grid-container-A"></div>
		<div class="grid-container" id="grid-container-B"></div>
		<div class="mask-container" id="mask-container-A"></div>
		<div class="mask-container" id="mask-container-B"></div>
		<div class="sectionLabel" id="sectionLabelC" style="top:50%" onclick="requestFullScreen();"><span style="position:absolute;top:20.5%;height:50%;color:white;left:40%; text-decoration: underline;">Global Controls</span></div>
		<div class="sectionLabel" id="sectionLabelD" style="top:50%" onclick="requestFullScreen();"><span style="position:absolute;top:20.5%;height:50%;color:white;left:42%; text-decoration: underline;">DMX</span></div>
		<div class="slider-container" id="slider-container">
			<div class="sliderLabel" style="top:0%"><span style="position:relative; top:35%;height:50%;text-decoration: underline;">ShaderA Level</span></div>
			<input type="range" min="0" max="1000" value="50" class="customSlider" id="slider1a" style="top:0%">
			<div class="sliderLabel" style="top:20%"><span style="position:relative; top:35%;height:50%;text-decoration: underline;">ShaderB Level</span></div>
			<input type="range" min="0" max="1000" value="50" class="customSlider" id="slider1b" style="top:20%">		
			<div class="sliderLabel" style="top:40%"><span style="position:relative; top:35%;height:50%;text-decoration: underline;">DMX Level</span></div>
			<input type="range" min="0" max="1000" value="50" class="customSlider" id="slider2" style="top:40%">		
			<div class="sliderLabel"  style="top:60%"><span style="position:relative; top:35%;height:50%;text-decoration: underline;">DMX Speed</span></div>
			<input type="range" min="0" max="4000" value="50" class="customSlider" id="slider3" style="top:60%">		
			<div class="sliderLabel"  style="top:80%; z-index:3"><span style="font-size: .85em;position:relative; top:40%; height:60%; z-index:2;text-decoration: underline;">Volume Threshold</span></div>
			<input type="range" min="1" max="100" value="50" class="customSlider" id="slider4" style="top:80%; z-index:4;">		
		</div>
		<div class="dmx-grid-container" id="dmx-grid-container" style="display:grid"></div>
		<div class="dmx-overrides-container" id="dmx-overrides-container">
			<input type="range" min="10" max="2550" value="50" class="dmx-overrides-controls" id="dmxOverrideSlider1" onchange="updateDMXOverrideSliders();">
			<input type="range" min="10" max="2550" value="50" class="dmx-overrides-controls" id="dmxOverrideSlider2" onchange="updateDMXOverrideSliders();">
			<input type="range" min="10" max="2550" value="50" class="dmx-overrides-controls" id="dmxOverrideSlider3" onchange="updateDMXOverrideSliders();">
			<input type="range" min="10" max="2550" value="50" class="dmx-overrides-controls" id="dmxOverrideSlider4" onchange="updateDMXOverrideSliders();">
		</div>
		<div id="dmx-misc-container" id="dmx-misc-container" style="display:none;">
			<button id="globalResetAllButton" class="dmxMiscButtons" onclick="resetToDefaultPreset();">Reset All Presets</button>
			<button id="miscButton2" class="dmxMiscButtons" onclick="saveDMXOverridesForAllPresets(1);" >Save DMX Overrides for All Presets</button>
			<button id="miscButton3" class="dmxMiscButtons" onclick="rebootPi();" >Reboot Pi</button>
			<button id="miscButton4" class="dmxMiscButtons" onclick="toggleDMXOverridesCourseFine();" >DMX Overrides Course/Fine</button>
		</div>
		<div id="dmxPageSelectorContainer">
			<button class="dmxPageSelectorButtons" id="dmxPageButton1" style="background-color: grey;" onclick="selectDMXPage(this,'presets');" >Presets</button>
			<button class="dmxPageSelectorButtons" id="dmxPageButton2"  onclick="selectDMXPage(this,'overrides');" >Overrides</button>
			<button class="dmxPageSelectorButtons" id="dmxPageButton3"  onclick="selectDMXPage(this,'misc');" >Misc</button>
		</div>
		<div class="presets-grid-container" id="presets-grid-container" style="z-index:1;"></div>
		<div class="fm-scene-grid-container" id="fm-scene-grid-container" style="z-index:1;">
			<button class="fm-scene-grid-container-item" style="text-decoration: underline;">Flowmapper Scenes:</button>
			<button class="fm-scene-grid-container-item" onclick="setCurrentFMScene(0,this)" >1</button>
			<button class="fm-scene-grid-container-item" onclick="setCurrentFMScene(1,this)" >2</button>
			<button class="fm-scene-grid-container-item" onclick="setCurrentFMScene(2,this)" >3</button>
			<button class="fm-scene-grid-container-item" onclick="setCurrentFMScene(3,this)" >4</button>
		</div>
		<div class="mapping-controls-grid-container" id="mapping-controls-grid-container" style="z-index:1; display:none;">
			<button class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em; text-decoration: underline;">Objects:</button>
			<button id="mapping-controls-grid-item-1" onclick="selectObject(this.getAttribute('intValue'),this.id);" intValue="0" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">1</button>
			<button id="mapping-controls-grid-item-2" onclick="selectObject(this.getAttribute('intValue'),this.id);" intValue="1" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">2</button>
			<button id="mapping-controls-grid-item-3" onclick="selectObject(this.getAttribute('intValue'),this.id);" intValue="2" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">3</button>
			<button id="mapping-controls-grid-item-4" onclick="selectObject(this.getAttribute('intValue'),this.id);" intValue="3" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">4</button>
			<button class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em; text-decoration: underline;">Object Settings:</button>			
			<button id="mapping-controls-selected-visibility" onclick="updateObject('visible');" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">Visible</button>
			<button id="mapping-controls-selected-shader" onclick="updateObject('shader');" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">Shader AB</button>		
			<button class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em; text-decoration: underline;">ZValue:</button>
			<input type="range" min="-20" max="20" value="0" onchange="updateObject('zValue');" id="zSlider" style="">
			<button id="courseFineButton" class="mapping-controls-grid-item" onclick="toggleFineMapping();" style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">Course / Fine</button>
		</div>
		<div id="mapping_mode_right_border" style="height:100%; width:5px; right:0px; top:0px; position:absolute; display:block; z-index:1; background-color:grey;" ></div>
		<div class="mapping-controls-grid-container-top" id="mapping-controls-grid-container-top" style="z-index:1; display:none;">
			<button class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em; text-decoration: underline;">Selected Vertice:</button>
			<button id="selectVertice1" onclick="selectVertice(this.getAttribute('intValue'),this);" intValue="0" class="mapping-controls-grid-item"  style="border-color: grey; background-color: grey; color: white; font-size: 0.5em;">1</button>
			<button id="selectVertice2" onclick="selectVertice(this.getAttribute('intValue'),this);" intValue="1" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">2</button>
			<button id="selectVertice3" onclick="selectVertice(this.getAttribute('intValue'),this);" intValue="2" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">3</button>
			<button id="selectVertice4" onclick="selectVertice(this.getAttribute('intValue'),this);" intValue="3" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">4</button>
			<button id="duplicateSaveMap" onclick="saveMapForAllPresets(1);" class="mapping-controls-grid-item"  style="border-right:3.5px solid grey; border-color: grey; background-color: black; color: white; font-size: 0.5em;">Save Map for All Presets</button>
			<!-- <button id="globalResetAll" onclick="resetToDefaultPreset();" class="mapping-controls-grid-item"  style="border-color: grey; background-color: black; color: white; font-size: 0.5em;">Reset All Presets</button> -->
		</div>
		<div class="menu-grid-container" id="menu-grid-container"style="z-index:1;">
			<button class="menu-grid-container-item" id="Misc_Button" onclick="selectPage(this);" style="border-color: grey; background-color: black; color: white; ">Misc</button>
			<button class="menu-grid-container-item"  id="VJ_Button" onclick="selectPage(this);" style="border-color: grey; background-color: black; color: white; ">VJ</button>
			<button class="menu-grid-container-item"  id="Mapping_Button" onclick="selectPage(this);" style="border-color: grey; background-color: black; color: white; ">Map</button>
			<button class="menu-grid-container-item"  id="FM_Button" onclick="selectPage(this);" style="border-color: grey; background-color: black; color: white;">FM</button>
		</div>
		<div class="menu-page" id="misc_page"></div>
		<div class="menu-page" id="mapping_page" style="z-index:-2;"></div>
		<div class="menu-page" id="fm_page">
			<button class="fm_controls_slider_label" >Brightness Sensitivity:</button>
			<input type="range" min="0" max="1000" value="50" class="fm_controls" id="BrightnessSensitivity" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Motion Sensitivity:</button>
			<input type="range" min="0" max="1000" value="50" class="fm_controls" id="VelocitySensitivity" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Fade Time:</button>
			<input type="range" min="0" max="1000" value="50" class="fm_controls" id="FadeTime" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Color Mix:</button>
			<input type="range" min="0" max="1000" value="50" class="fm_controls" id="ColorMix" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Color Rate:</button>
			<input type="range" min="0" max="700" value="50" class="fm_controls" id="ColorRate" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Color Hop:</button>
			<input type="range" min="0" max="1000" value="50" class="fm_controls" id="ColorHop" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Kalidoscope:</button>
			<input type="range" min="1" max="4" value="1" class="fm_controls" id="KaleidoScope" onchange="updateFMState();">
			<button class="fm_controls_slider_label" style="text-decoration: underline;" >Scene Rate:</button>
			<input type="range" min="0" max="150" value="0" class="fm_controls" id="SceneRate" onchange="updateFMState();">
		</div>

		<div id="orientation_overlay" onclick="requestFullScreen();" style="background-color:black; height:100%; width:101%; left:0px; top:0px; position:absolute; display:none; z-index:1000000; color:white; font-size:48px; text-align: center; padding-top:15%" >Only Landscape Mode Supported. <div>Please rotate device 90 degrees!</div></div>

		<script id="vertexShader" type="x-shader/x-vertex">
			precision mediump float;
			precision mediump int;
			
			uniform mat4 modelViewMatrix; // optional
			uniform mat4 projectionMatrix; // optional
			
			attribute vec3 position;
			attribute vec4 color;
			attribute vec2 uv;
			
			varying vec3 vPosition;
			varying vec4 vColor;
			varying vec2 vUv;
			
			void main()	{
				vUv = uv;
				vPosition = position;
				vColor = color;
			
				gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
			
			}
		</script>
			
		<script id="fragmentShader1" type="x-shader/x-fragment">
			precision mediump float;
			precision mediump int;
			
			uniform float time;
			varying vec2 vUv;
			uniform sampler2D maskTexture;
			uniform sampler2D maskTexture2;
			
			void main( void ) {
				vec3 mask = texture2D( maskTexture, vUv ).rgb;
				gl_FragColor = vec4( vec3(  mask.r, 0.0, 0.0), mask.r );
			
			}			
		</script>
		
		<script id="fragmentShader2" type="x-shader/x-fragment">
			precision mediump float;
			precision mediump int;
			
			uniform float time;
			varying vec2 vUv;
			uniform sampler2D maskTexture;
			uniform sampler2D maskTexture2;
			
			void main( void ) {
				vec3 mask = texture2D( maskTexture, vUv ).rgb;
				gl_FragColor = vec4( vec3(  0.0, 0.0, mask.r), mask.r );
			
			}	
		</script>

		<script id="fragmentShader3" type="x-shader/x-fragment">
			precision mediump float;
			precision mediump int;
			
			uniform float time;
			varying vec2 vUv;
			uniform sampler2D maskTexture;
			uniform sampler2D maskTexture2;
			
			void main( void ) {
				vec3 mask = texture2D( maskTexture, vUv ).rgb;
				gl_FragColor = vec4( vec3(  0.0, 1.0, 0.0), 1.0 );
			
			}	
		</script>

		<script>

			initGlobalVars();
			
			function initGlobalVars(){
				miscXYCurrentMouseX=0;
				miscXYCurrentMouseY=0;
				miscXYLastMouseX=0;
				miscXYLastMouseY=0;
				miscXYIsSelected=false;
				createXYHandleOnMiscPage();
				dmxOverridesMouseDownArray=[false,false,false,false];
				dmxOverridesTouchDownArray=[false,false,false,false];
				dmxOverridesLastMouseXPositions=[0,0,0,0];
				dmxOverridesCourseFine=false;
				initDMXOverridesFineCourseListeners();
				currentDMXPage="presets";
				currentApp="sm";
				checkDeviceOrientation();
				lastMouseX=0;
				lastMouseY=0;
				mouseVelX=0;
				mouseVelY=0;
				mouseIsDown=false;
				fineMappingEnabled=false;
				slaveModeInterval=-1;
				controllerModeInterval=-1;
				getCanvasYFlip();
				getNumberOfShadersAndPresets();
				lastMaskAValue=-1;
				lastMaskBValue=-1;
				fade_Position=0;
				// setTimeout(function(){recallState(false);},10);
				initGlobalController();
				dmxInterval=0;
				maxNumDMXScenes=8;
				dmxPresetData=[];
				selectedVertice=0;
				// width=document.getElementById('video').width;
				// height=document.getElementById('video').height;	
				width=32;
				height=32;
				materialArray=new Uint8Array(width * height * 4);
				// previousData=new Uint8Array(width * height * 4);
				// data=new Uint8Array(width * height * 4);
				isFirstCycle=true;
				colorCounter=0.0;
				// getVideo("init",0)
				container=null;
				camera=null;
				controls=null;
				scene=null;
				renderer=null;
				objects = [];
				displayObjects=[];
				plane = new THREE.Plane();
				raycaster = new THREE.Raycaster();
				mouse = new THREE.Vector2();
				offset = new THREE.Vector3();
				intersection = new THREE.Vector3();
				INTERSECTED=null;
				SELECTED=null;
				initScene();
				animate();
				statesArray=[];
				for(var x=0;x<4;x++){
					var objectJSON ={}
					for (var key in objectController) {
						objectJSON[key]=objectController[key]
					}
					statesArray.push(objectJSON)
				}
				for(var y=0;y<4;y++){
					addObject();
				}
				statesArray[0].Visible=true;
				//=------
				globalState={};
				for (var key in globalController) {
					globalState[key]=globalController[key]
				}
				//=------
				syncObjectsToJson();
				initControllerDone=false;
				isMidPresetChange=false;
				getCurrentPresetName();
				setTimeout(function(){selectObject(0, "mapping-controls-grid-item-1");},1000);
				highlightSelectedVertice();
				forceInitControllerMode();
				getCurrentFMScene();
			}
			
			function createXYHandleOnMiscPage(){
				var xyBackdrop=document.createElement('div');
				xyBackdrop.id="xyBackdrop";
				xyBackdrop.style.backgroundColor="black";
				xyBackdrop.style.border="1px solid grey";
				xyBackdrop.style.position="absolute";
				xyBackdrop.style.width="90%";
				xyBackdrop.style.height="80%";
				xyBackdrop.style.left="5%";
				xyBackdrop.style.top="10%";
				document.getElementById("misc_page").appendChild(xyBackdrop);

				var xyHandleElement=document.createElement('div');
				xyHandleElement.id="xyHandleElement";
				xyHandleElement.style.backgroundColor="blue";
				xyHandleElement.style.position="absolute";
				xyHandleElement.style.width="40px";
				xyHandleElement.style.height="40px";
				xyHandleElement.style.left="0px";
				xyHandleElement.style.top="0px";
				xyHandleElement.style.borderRadius="20px";
				document.getElementById("misc_page").appendChild(xyHandleElement);
				
				xyHandleElement.onmousedown=function(event){
					miscXYLastMouseX=event.clientX;
					miscXYLastMouseY=event.clientY;
					miscXYIsSelected=true;
				}

				xyHandleElement.onmouseup=function(event){
					miscXYIsSelected=false;
				}

				xyBackdrop.onmousemove=function(event){
					if(miscXYIsSelected==true){
						console.log(event)
						var velocityX=event.clientX-miscXYLastMouseX;
						var velocityY=event.clientY-miscXYLastMouseY;
						xyHandleElement.style.left=parseInt(parseInt(xyHandleElement.style.left.substring(0,xyHandleElement.style.left.length-2))+velocityX)+"px";
						xyHandleElement.style.top=parseInt(parseInt(xyHandleElement.style.top.substring(0,xyHandleElement.style.top.length-2))+velocityY)+"px";
						miscXYLastMouseX=event.clientX;
						miscXYLastMouseY=event.clientY;
						miscXYCurrentMouseX=parseInt(xyHandleElement.style.left.substring(0,xyHandleElement.style.left.length-2));
						miscXYCurrentMouseY=parseInt(xyHandleElement.style.top.substring(0,xyHandleElement.style.top.length-2));
						globalState.xyPadX=Math.abs(miscXYCurrentMouseX/window.innerWidth*1.1);
						globalState.xyPadY=Math.abs(miscXYCurrentMouseY/window.innerHeight*1.5)
						// console.log( Math.abs(miscXYCurrentMouseX/window.innerWidth*1.1) +"  "+ Math.abs(miscXYCurrentMouseY/window.innerHeight*1.5) )
					}
				}

				xyBackdrop.ontouchstart=function(event){
					miscXYLastMouseX=event.clientX;
					miscXYLastMouseY=event.clientY;
				}
				
				xyBackdrop.ontouchmove=function(event){
					miscXYCurrentMouseX=event.touches[0].clientX-window.innerWidth*.1;
					miscXYCurrentMouseY=event.touches[0].clientY-window.innerHeight*.06;
					if(miscXYCurrentMouseX > window.innerWidth*.05 && miscXYCurrentMouseX < window.innerWidth*.825){
						if(miscXYCurrentMouseY > window.innerHeight*.09 && miscXYCurrentMouseY < window.innerHeight*.68){
							xyHandleElement.style.left=miscXYCurrentMouseX+"px";
							xyHandleElement.style.top=miscXYCurrentMouseY+"px";
							globalState.xyPadX=Math.abs(miscXYCurrentMouseX/window.innerWidth*1.1);
							globalState.xyPadY=Math.abs(miscXYCurrentMouseY/window.innerHeight*1.5);
						}
					}
				}
			}

			function initDMXOverridesFineCourseListeners(){
				document.onmouseup=function(){
					if(dmxOverridesCourseFine==true){
						for(var x=0; x<4; x++){
							dmxOverridesMouseDownArray[x]=false;
						}
						console.log("dmxOverridesMouseDownArray:"+dmxOverridesMouseDownArray);
					}
				}
				for(var x=0; x<4; x++){
					document.getElementById("dmxOverrideSlider"+parseInt(x+1)).onmousedown=function(event){
						if(dmxOverridesCourseFine==true){
							event.preventDefault();
							var x=event.path[0].id;
							x=parseInt(x.substring(x.length-1,x.length))-1;
							dmxOverridesMouseDownArray[x]=true;
							console.log("dmxOverridesMouseDownArray:"+dmxOverridesMouseDownArray);
						}
					}
					document.getElementById("dmxOverrideSlider"+parseInt(x+1)).onmousemove=function(event){
						if(dmxOverridesCourseFine==true){
							event.preventDefault();
							var x=event.path[0].id;
							x=parseInt(x.substring(x.length-1,x.length))-1;
							var overrideVelocity=(event.screenX-dmxOverridesLastMouseXPositions[x])/2;
							if(dmxOverridesMouseDownArray[x]==true){
								document.getElementById(event.path[0].id).value=parseInt(document.getElementById(event.path[0].id).value)+overrideVelocity;
							}
							dmxOverridesLastMouseXPositions[x]=event.screenX;
						}
						updateDMXOverrideSliders();
					}
				}
			
				document.ontouchend=function(){
					if(dmxOverridesCourseFine==true){
						for(var x=0; x<4; x++){
							dmxOverridesTouchDownArray[x]=false;
						}
						console.log("dmxOverridesTouchDownArray:"+dmxOverridesTouchDownArray);
					}
				}
				for(var x=0; x<4; x++){
					document.getElementById("dmxOverrideSlider"+parseInt(x+1)).ontouchstart=function(event){
						if(dmxOverridesCourseFine==true){
							event.preventDefault();
							var x=event.path[0].id;
							x=parseInt(x.substring(x.length-1,x.length))-1;
							dmxOverridesTouchDownArray[x]=true;
							console.log("dmxOverridesTouchDownArray:"+dmxOverridesTouchDownArray);
							dmxOverridesLastMouseXPositions[x]=event.touches[0].screenX;
						}
					}
					document.getElementById("dmxOverrideSlider"+parseInt(x+1)).ontouchmove=function(event){
						if(dmxOverridesCourseFine==true){
							event.preventDefault();
							var x=event.path[0].id;
							x=parseInt(x.substring(x.length-1,x.length))-1;
							var overrideVelocity=(event.touches[0].screenX-dmxOverridesLastMouseXPositions[x])/2;
							if(dmxOverridesTouchDownArray[x]==true){
								document.getElementById(event.path[0].id).value=parseInt(document.getElementById(event.path[0].id).value)+overrideVelocity;
							}
							dmxOverridesLastMouseXPositions[x]=event.touches[0].screenX;
						}
						updateDMXOverrideSliders();
					}
				}
			}
			
			function toggleDMXOverridesCourseFine(){
				if(dmxOverridesCourseFine==false){
					document.getElementById("miscButton4").style.backgroundColor="lightgrey";
					dmxOverridesCourseFine=true;
				}else{
					document.getElementById("miscButton4").style.backgroundColor="darkgrey";
					dmxOverridesCourseFine=false;
				}
			}

			function selectDMXPage(elem,mode){
				currentDMXPage=mode;
				document.getElementById("dmxPageButton1").style.backgroundColor="black";
				document.getElementById("dmxPageButton2").style.backgroundColor="black";
				document.getElementById("dmxPageButton3").style.backgroundColor="black";
				elem.style.backgroundColor="grey";
				if(mode=="presets"){
					document.getElementById("dmx-grid-container").style.display="grid";
					document.getElementById("dmx-overrides-container").style.display="none";
					document.getElementById("dmx-misc-container").style.display="none";
				}
				if(mode=="overrides"){
					document.getElementById("dmx-grid-container").style.display="none";
					document.getElementById("dmx-overrides-container").style.display="grid";
					document.getElementById("dmx-misc-container").style.display="none";
				}
				if(mode=="misc"){
					document.getElementById("dmx-grid-container").style.display="none";
					document.getElementById("dmx-overrides-container").style.display="none";
					document.getElementById("dmx-misc-container").style.display="grid";
				}
			}

			function forceInitControllerMode(){
				var requestBody="true"
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/write.php?fn=globalPresets/forceInitControllerMode.txt", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log("Wrote 'true' to forceInitControllerMode");
				}
			}
			
			function updateDMXOverrideSliders(){
				globalState.DMX_X1=parseInt(document.getElementById("dmxOverrideSlider1").value)/10;
				globalState.DMX_Y1=parseInt(document.getElementById("dmxOverrideSlider2").value)/10;
				globalState.DMX_X2=parseInt(document.getElementById("dmxOverrideSlider3").value)/10;
				globalState.DMX_Y2=parseInt(document.getElementById("dmxOverrideSlider4").value)/10;
			}
			
			function checkDeviceOrientation(){
				var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
				if (orientation.indexOf("landscape")!=-1) {
					document.getElementById("orientation_overlay").style.display="none";
				}else{
					document.getElementById("orientation_overlay").style.display="block";
				}
				window.addEventListener("orientationchange", function() {
					var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
					if (orientation.indexOf("landscape")!=-1) {
						document.getElementById("orientation_overlay").style.display="none";
					}else{
						document.getElementById("orientation_overlay").style.display="block";
					}
				}, false);
				window.addEventListener("resume", function() {
					var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
					if (orientation.indexOf("landscape")!=-1) {
						document.getElementById("orientation_overlay").style.display="none";
					}else{
						document.getElementById("orientation_overlay").style.display="block";
					}
				}, false);
			}
			
			function resetToDefaultPreset(){
				var presetNumber=1;
				globalController.PresetName="GlobalPreset"+parseInt(presetNumber);
				isMidPresetChange=true;
				recallState(true);
				for(var x=1; x<=8; x++){
					if(parseInt(presetNumber)==x){
						document.getElementById("PresetsGridItem"+x).style.backgroundColor="grey"
						console.log("Setting currentPreset to: "+parseInt(presetNumber));
						setCurrentPresetNumber(parseInt(presetNumber));
					}else{
						document.getElementById("PresetsGridItem"+x).style.backgroundColor="black"
					}
				}
			}
			
			function resetToDefaultAllPresets(destinationPresetNumber){
				if(destinationPresetNumber<9){
					var xmlhttp=new XMLHttpRequest();
					xmlhttp.open("GET", "../php/read.php?fn=globalPresets/GlobalPreset1.txt", true);
					xmlhttp.send();
					xmlhttp.onload = function(e){
						var tempAllStates=JSON.parse(xmlhttp.response);
						tempAllStates.global.SavedByController=true;
						
						var xmlhttp2=new XMLHttpRequest();
						xmlhttp2.open("POST", "../php/write.php?fn=globalPresets/GlobalPreset"+destinationPresetNumber+".txt", true);
						xmlhttp2.send(JSON.stringify(tempAllStates));
						xmlhttp2.onload = function(e){
							resetToDefaultAllPresets(destinationPresetNumber+1);
						}
					}
				}
				if(destinationPresetNumber==1){
					var xmlhttp3=new XMLHttpRequest();
					xmlhttp3.open("GET", "../php/read.php?fn=flowMapperPresets/Default_Preset.txt", true);
					xmlhttp3.send();
					xmlhttp3.onload = function(e){
						var tempAllStates=JSON.parse(xmlhttp3.response);
						tempAllStates.SavedByController=true;
						
						var xmlhttp4=new XMLHttpRequest();
						xmlhttp4.open("POST", "../php/write.php?fn=flowMapperPresets/Preset_1.txt", true);
						xmlhttp4.send(JSON.stringify(tempAllStates));
						xmlhttp4.onload = function(e){
						console.log("Reset FM presets");

						getCurrentFMScene();
						}
					}
				}
			}
			
			function selectVertice(verticeNum, elem){
				for(var x=1; x<5; x++){
					document.getElementById("selectVertice"+x).style.backgroundColor="black"
				}
				elem.style.backgroundColor="grey";
				selectedVertice=verticeNum;
				highlightSelectedVertice();
			}

			function toggleFineMapping(){
				fineMappingEnabled=!fineMappingEnabled;
				if(fineMappingEnabled){
					document.getElementById("courseFineButton").style.backgroundColor='grey';
				}else{
					document.getElementById("courseFineButton").style.backgroundColor='black';
				}
			}
			
			function initShaderMaterial(uniforms1){
				matList=[];
				for(var x=1;x<=3;x++){
					if(x==1){
						var material = new THREE.RawShaderMaterial( {
							uniforms: uniforms1,
							vertexShader: document.getElementById( 'vertexShader' ).textContent,
							fragmentShader: document.getElementById( 'fragmentShader'+x ).textContent
						} );	
					}else{
						var material = new THREE.RawShaderMaterial( {
							uniforms: uniforms2,
							vertexShader: document.getElementById( 'vertexShader' ).textContent,
							fragmentShader: document.getElementById( 'fragmentShader'+x ).textContent
						} );	
					}		
					material.side=THREE.DoubleSide;
					// material.transparent=true;
					matList.push(material)		
				}
				return matList;
			}
		
			function changeMask(changedMask){
				if(changedMask==1){
					if(parseInt(globalState.MaskA)!=lastMaskAValue){
						uniforms1.maskTexture={ value: new THREE.TextureLoader().load( '../masks/mask'+parseInt(globalState.MaskA)+'.jpg' ) };
						lastMaskAValue=parseInt(globalState.MaskA);
					}
				}else{
					if(parseInt(globalState.MaskB)!=lastMaskBValue){
						uniforms2.maskTexture={ value: new THREE.TextureLoader().load( '../masks/mask'+parseInt(globalState.MaskB)+'.jpg' ) };
						lastMaskBValue=parseInt(globalState.MaskB);
					}
				}
			}

			function initScene() {
				// prevData=pixel8(video,0,0,width,height)
				imgTexture = new THREE.TextureLoader().load( '../masks/mask1.jpg' );
				imgTexture2 = new THREE.TextureLoader().load( '../masks/mask2.jpg' );
				dataTexture=[]	
				dataTexture = new THREE.DataTexture( materialArray, width, height, THREE.RGBAFormat );
				dataTexture.needsUpdate = true;
				uniforms1 = {
					"time": { value: 1.0 },
					"resolution": [width,height],
					"mousex": { value: 0.0 },
					"mousey": { value: 0.0 },
					"audioVolume": { value: 0.0 },
					"maskTexture": { value: imgTexture },
					"brightness": { value: globalController.BrightnessA }
				};
				uniforms2 = {
					"time": { value: 1.0 },
					"resolution": [width,height],
					"mousex": { value: 0.0 },
					"mousey": { value: 0.0 },
					"audioVolume": { value: 0.0 },
					"maskTexture": { value: imgTexture2 },
					"brightness": { value: globalController.BrightnessB }
				};
				// uniforms1[ "maskTexture" ].value.wrapS = uniforms1[ "maskTexture" ].value.wrapT = THREE.MirroredRepeatWrapping;
				materialsList=initShaderMaterial(uniforms1);
				container = document.createElement( 'div' );
				document.body.appendChild( container );
				frustumSize = 1000;
				var aspect = window.innerWidth / window.innerHeight;
				camera = new THREE.OrthographicCamera( frustumSize * aspect / - 2, frustumSize * aspect / 2, frustumSize / 2, frustumSize / - 2, 0, 10000 );
				camera.position.z = -1000;
				controls = new THREE.TrackballControls( camera , container);
				controls.enabled=false;
				scene = new THREE.Scene();
				LIGHTING=new THREE.AmbientLight( 0xffffff ) 
				scene.add( LIGHTING );
				renderer = new THREE.WebGLRenderer( { antialias: true , alpha:true} );
				renderer.setClearColor( 0x000000 , 1);
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.domElement.style.display="none";
				renderer.sortObjects = true;
				container.appendChild( renderer.domElement );
				renderer.domElement.addEventListener( 'mousemove', onDocumentMouseMove, false );
				renderer.domElement.addEventListener( 'mousedown', onDocumentMouseDown, false );
				renderer.domElement.addEventListener( 'mouseup', onDocumentMouseUp, false );
				renderer.domElement.addEventListener( 'touchmove', onDocumentTouchMove, false );
                renderer.domElement.addEventListener( 'touchstart', onDocumentTouchStart, false );
                renderer.domElement.addEventListener( 'touchend', onDocumentTouchEnd, false );
				window.addEventListener( 'resize', onWindowResize, false );
				// tempElem=document.body.getElementsByClassName('ac')[0];
				// tempElem.className="";
				// tempElem.style.zIndex='10000000'
				// tempElem.style.position='fixed'
				// tempElem.style.right='0px';
			}
				
			function initGlobalController(){
				globalController  = {
					selectedObject:0,
					mappingMode:0,
					ShaderA:1,
					ShaderB:2,
					MaskA:1,
					MaskB:2,
					PresetName:"GlobalPreset1",
					SendDMX:true,
					DMX_Rate: 50,
					DMX_Brightness:.5,
					DMX_Pattern:1,
					DMX_Pattern_Rate:.1,
					Universe:1,
					DMX_X1:0,
					DMX_Y1:175,
					DMX_X2:150,
					DMX_Y2:175,
					VolumeThreshold:.003,
					Camera_X:0.0,
					Camera_Y:0.0,
					BrightnessA:1.0,
					BrightnessB:1.0,
					SavedByController:true,
				}
				objectController  = {
					 Visible:false,
					 ZValue:0,
					 Shader:1
				};
				var count=0; 
				for(var y=4; y>=0;y--){
					for(var x=0; x<5;x++){
						objectController["VerticeX"+count]=-200+100*x;
						objectController["VerticeY"+count]=-200+100*y;
						count=count+1;
					}
				}
			}

			function getControllerData(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=globalPresets/"+globalController.PresetName+".txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
					statesArray=JSON.parse(xmlhttp.response).storage
					globalState=JSON.parse(xmlhttp.response).global
					// presetsArray=JSON.parse(xmlhttp.response).storage2
					
					syncObjectsToJson(true);
					for(var x=0;x<displayObjects[globalController.selectedObject].children.length;x++){ displayObjects[globalController.selectedObject].children[x].visible=false; };
				}
			}

			function syncObjectsToJson(includGlobal){
				if(currentApp=="sm"){
					for(var x=0;x<displayObjects.length;x++){
						displayObjects[x].setState(statesArray[x])
					}
				}
				if(currentApp=="fm"){
					for(var x=0;x<displayObjects.length;x++){
						displayObjects[x].setState(fm_statesArray[x])
					}
				}
			}
			
			function addObject(){
			  function createGeometry(u,v){
					nsControlPoints = [
						 [
							 new THREE.Vector4 ( -200, -200, 0, 1 ),
							 new THREE.Vector4 ( -200, -100, 0, 1 ),
							 new THREE.Vector4 ( -200, 100, 0, 1 ),
							 new THREE.Vector4 ( -200, 200, 0, 1 )
						 ],
						 [
							 new THREE.Vector4 ( 0, -200, 0, 1 ),
							 new THREE.Vector4 ( 0, -100, 0, 1 ),
							 new THREE.Vector4 ( 0, 100, 0, 1 ),
							 new THREE.Vector4 ( 0, 200, 0, 1 )
						 ],
						 [
							 new THREE.Vector4 ( 200, -200, 0, 1 ),
							 new THREE.Vector4 ( 200, -100, 0, 1 ),
							 new THREE.Vector4 ( 200, 100, 0, 1 ),
							 new THREE.Vector4 ( 200, 200, 0, 1 )
						 ]
					 ];
					 degree1 = 2
					 degree2 = 3;
					 knots1 = [0, 0, 0, 1, 1, 1];
					 knots2 = [0, 0, 0, 0, 1, 1, 1, 1];
					 nurbsSurface = new THREE.NURBSSurface(degree1, degree2, knots1, knots2, nsControlPoints);
					 return nurbsSurface.getPoint(u, v);		
			  }
			  function createObject(){
				var geometry = new THREE.ParametricGeometry( createGeometry, 4, 4 );			  
				//var geometry=new THREE.BoxGeometry( 10, 10, 10 );
				var object = new THREE.Mesh( geometry, materialsList[0]);	
				object.shaderNumber=0;			
				return object;
			  }
			  var object = createObject();
			  object.showChildren=function(){
			        if (globalController.mappingMode>.5) {
						for(var x=0; x<object.children.length ;x++){
								object.children[x].visible=true;							
						}
					}else{
						for(var x=0; x<object.children.length ;x++){
							if (object.children[x].isCorner==true) {
								object.children[x].visible=true;
								object.updatecorners;
							}
						}					
					}
			  }
			  object.hideChildren=function(){
				for(var x=object.children.length-1;x>=0 ;x--){
						object.children[x].visible=false;			
				}
			  }
			  object.drawV=function(){
				for(var x=0; x<object.geometry.vertices.length ; x++ ){
					//var  geo = new THREE.BoxGeometry( 35, 35, 0 );
					//var mat = new THREE.PointsMaterial( { size: 300, vertexColors: THREE.VertexColors , color: 0xffffff } );
					//var mesh1 = new THREE.Mesh( geo, mat );
					mesh1 = new THREE.Mesh( new THREE.CircleGeometry(60, 60, 0, Math.PI * 2 ), new THREE.MeshPhongMaterial({side: THREE.DoubleSide, color:0xffffff}))
					mesh1.name="vertice"+x;
					mesh1.isCorner=false;
					if (x == 0 || x == 4 || x == 24 || x == 20) {
						mesh1.isCorner=true;
					}
					mesh1.vertNum=x;
					mesh1.position.x=object.geometry.vertices[x].x;
					mesh1.position.y=object.geometry.vertices[x].y;
					mesh1.position.z=-500;
					object.add(mesh1)
					objects.push(mesh1)
				}
			  }
			  object.setState=function(savedJSON){
				object.visible=savedJSON.Visible;
				object.position.z= savedJSON.ZValue;
				if(currentApp=="sm"){
					object.material=materialsList[parseInt(savedJSON.Shader-1)];
				}
				if(currentApp=="fm"){
					object.material=materialsList[2];
				}
				object.shaderNumber=parseInt(savedJSON.Shader-1);
				for(var x=0;x<object.geometry.vertices.length;x++){
					object.geometry.vertices[x].x=savedJSON["VerticeX"+x]
					object.geometry.vertices[x].y=savedJSON["VerticeY"+x]
					object.children[x].position.x=savedJSON["VerticeX"+x]
					object.children[x].position.y=savedJSON["VerticeY"+x]
				}
				object.geometry.verticesNeedUpdate = true;
			  }	  
			  object.updateCorners=function(){
					var cornerNum=[];
					cornerNum[0]=0;
					cornerNum[1]=Math.sqrt(object.geometry.vertices.length)-1
					cornerNum[2]=object.geometry.vertices.length-1-(Math.sqrt(object.geometry.vertices.length)-1)
					cornerNum[3]=object.geometry.vertices.length-1
					var x1 = object.geometry.vertices[cornerNum[0]].x
					var y1 = object.geometry.vertices[cornerNum[0]].y
					var x2 = object.geometry.vertices[cornerNum[1]].x
					var y2 = object.geometry.vertices[cornerNum[1]].y
					var x3 = object.geometry.vertices[cornerNum[2]].x
					var y3 = object.geometry.vertices[cornerNum[2]].y
					var x4 = object.geometry.vertices[cornerNum[3]].x
					var y4 = object.geometry.vertices[cornerNum[3]].y
					var xDiff1=(x2-x1)/(Math.sqrt(object.geometry.vertices.length)-1)
					var yDiff1=(y2-y1)/(Math.sqrt(object.geometry.vertices.length)-1)
					for(var x=0; x<Math.sqrt(object.geometry.vertices.length);x++){
						 object.geometry.vertices[x].x=+object.geometry.vertices[0].x+xDiff1*x;
						 object.geometry.vertices[x].y=object.geometry.vertices[0].y+yDiff1*x;
					}
					xDiff1=(x3-x1)/(Math.sqrt(object.geometry.vertices.length)-1)
					yDiff1=(y3-y1)/(Math.sqrt(object.geometry.vertices.length)-1)
					for(var x=0; x<Math.sqrt(object.geometry.vertices.length);x++){
						 object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length))*x].x=+object.geometry.vertices[0].x+xDiff1*x;
						 object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length))*x].y=object.geometry.vertices[0].y+yDiff1*x;
					}
					xDiff1=(x4-x3)/(Math.sqrt(object.geometry.vertices.length)-1)
					yDiff1=(y4-y3)/(Math.sqrt(object.geometry.vertices.length)-1)
					for(var x=object.geometry.vertices.length-1; x>object.geometry.vertices.length-Math.sqrt(object.geometry.vertices.length);x--){
						 object.geometry.vertices[x].x=object.geometry.vertices[object.geometry.vertices.length-1].x+xDiff1*(x-(object.geometry.vertices.length-1));
						 object.geometry.vertices[x].y=object.geometry.vertices[object.geometry.vertices.length-1].y+yDiff1*(x-(object.geometry.vertices.length-1));
					}
					xDiff1=(x4-x2)/(Math.sqrt(object.geometry.vertices.length)-1)
					yDiff1=(y4-y2)/(Math.sqrt(object.geometry.vertices.length)-1)
					for(var x=0; x<Math.sqrt(object.geometry.vertices.length);x++){
						 object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length))*x+Math.sqrt(object.geometry.vertices.length)-1].x=object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length)-1)].x+xDiff1*(x);
						 object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length))*x+Math.sqrt(object.geometry.vertices.length)-1].y=object.geometry.vertices[(Math.sqrt(object.geometry.vertices.length)-1)].y+yDiff1*(x);
					}
					var sqrt=(Math.sqrt(object.geometry.vertices.length))
					var numOfMiddleRows=(Math.sqrt(object.geometry.vertices.length)-2)
					for(var rowNum = 1; rowNum < (Math.sqrt(object.geometry.vertices.length)-1) ; rowNum ++){
						 var x1 = object.geometry.vertices[rowNum*sqrt].x
						 var y1 = object.geometry.vertices[rowNum*sqrt].y
						 var x2 = object.geometry.vertices[rowNum*sqrt+(sqrt-1)].x
						 var y2 = object.geometry.vertices[rowNum*sqrt+(sqrt-1)].y
						 xDiff1=(x2-x1)/(Math.sqrt(object.geometry.vertices.length)-1)
						 yDiff1=(y2-y1)/(Math.sqrt(object.geometry.vertices.length)-1)
						 for(var x=0; x<(Math.sqrt(object.geometry.vertices.length)-1) ; x++ ){
							  object.geometry.vertices[rowNum*sqrt+x].x= x1+xDiff1*x;
							  object.geometry.vertices[rowNum*sqrt+x].y= y1+yDiff1*x;
						 }
					}
					
					object.geometry.verticesNeedUpdate = true;
					//object.drawV()
					for(var x=0;x<object.geometry.vertices.length;x++){
						objectController["VerticeX"+x]=object.geometry.vertices[x].x;
						objectController["VerticeY"+x]=object.geometry.vertices[x].y;
					}
					for(var x=0;x<object.children.length;x++){
						if(object.children[x].name.indexOf("vertice"!=0)){
							object.children[x].position.x=object.geometry.vertices[x].x;
							object.children[x].position.y=object.geometry.vertices[x].y;
							if(currentApp=="sm"){
								console.log("ZZZZZZ")
								statesArray[globalController.selectedObject]["VerticeX"+x]=object.geometry.vertices[x].x;
								statesArray[globalController.selectedObject]["VerticeY"+x]=object.geometry.vertices[x].y;
							}else if(currentApp=="fm"){
								console.log("SSSSS")
								fm_statesArray[globalController.selectedObject]["VerticeX"+x]=object.geometry.vertices[x].x;
								fm_statesArray[globalController.selectedObject]["VerticeY"+x]=object.geometry.vertices[x].y;
							}
						}		
					}
					
					//
			  }
			  object.drawV();
			  object.visible=false;
			  scene.add(object);
			  displayObjects.push(object);
			}

			function updateObject(controlType){

				if(controlType=="shader"){
					if(currentApp=="sm"){
						if(displayObjects[globalController.selectedObject].shaderNumber==0){
							displayObjects[globalController.selectedObject].material=materialsList[1];
							displayObjects[globalController.selectedObject].shaderNumber=1;
							document.getElementById("mapping-controls-selected-shader").style.backgroundColor="grey";
							statesArray[globalController.selectedObject].Shader=2;
						}else{
							displayObjects[globalController.selectedObject].material=materialsList[0];
							displayObjects[globalController.selectedObject].shaderNumber=0;
							document.getElementById("mapping-controls-selected-shader").style.backgroundColor="black";
							statesArray[globalController.selectedObject].Shader=1;
						}
					}
				}

				if(controlType=="visible"){
					if(currentApp=="sm"){
						if(displayObjects[globalController.selectedObject].visible==true){
							displayObjects[globalController.selectedObject].visible=false;
							document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="black";
							statesArray[globalController.selectedObject].Visible=false;
						}else{
							displayObjects[globalController.selectedObject].visible=true
							document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="grey";
							statesArray[globalController.selectedObject].Visible=true;
						}
					}
					if(currentApp=="fm"){
						if(displayObjects[globalController.selectedObject].visible==true){
							displayObjects[globalController.selectedObject].visible=false;
							document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="black";
							fm_statesArray[globalController.selectedObject].Visible=false;
						}else{
							displayObjects[globalController.selectedObject].visible=true
							document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="grey";
							fm_statesArray[globalController.selectedObject].Visible=true;
						}
					}
				}

				if(controlType=="zValue"){
					if(currentApp=="sm"){
						displayObjects[globalController.selectedObject].position.z=document.getElementById("zSlider").value;
						statesArray[globalController.selectedObject].ZValue=document.getElementById("zSlider").value;
					}
					if(currentApp=="fm"){
						displayObjects[globalController.selectedObject].position.z=document.getElementById("zSlider").value;
						fm_statesArray[globalController.selectedObject].ZValue=document.getElementById("zSlider").value;
					}
				}

			}

			function selectObject(objectNum, buttonId){
				globalController.selectedObject=parseInt(objectNum);
				buttonElem=document.getElementById(buttonId);
				// console.log(buttonElem.style);
				for(var x=0; x<displayObjects.length; x++){
					displayObjects[x].hideChildren()
					document.getElementById("mapping-controls-grid-item-"+parseInt(x+1)).style.backgroundColor="black";
				}
				displayObjects[parseInt(objectNum)].showChildren()
				buttonElem.style.backgroundColor="grey";
				
				if(displayObjects[parseInt(objectNum)].visible){
					document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="grey";
				}else{
					document.getElementById("mapping-controls-selected-visibility").style.backgroundColor="black";
				}

				if(displayObjects[parseInt(objectNum)].shaderNumber==1){
					document.getElementById("mapping-controls-selected-shader").style.backgroundColor="grey";
				}else{
					document.getElementById("mapping-controls-selected-shader").style.backgroundColor="black";
				}

				document.getElementById("zSlider").value=statesArray[parseInt(objectNum)].ZValue;
				
			}

			function onWindowResize() {
				var aspect = window.innerWidth / window.innerHeight;
				camera.left   = - frustumSize * aspect / 2;
				camera.right  =   frustumSize * aspect / 2;
				camera.top    =   frustumSize / 2;
				camera.bottom = - frustumSize / 2;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.getElementById("xyHandleElement").style.left=parseInt(globalState.xyPadX/1.1*window.innerWidth)+"px";
				document.getElementById("xyHandleElement").style.top=parseInt(globalState.xyPadY/1.5*window.innerHeight)+"px";
			}
			
			function onDocumentTouchMove(event){

				if(fineMappingEnabled==false){
					if (SELECTED) {
						if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
							console.log(SELECTED)
							SELECTED.parent.updateCorners();
						}
					}
				}

				mouse.x = ( event.touches[0].clientX / window.innerWidth ) * 2.0 - 1.0;
                mouse.y = - ( event.touches[0].clientY / window.innerHeight ) * 2.0 + 1.0;
				
				if(fineMappingEnabled==true){
					if(mouseIsDown==true){
						mouseVelX=(lastMouseX-mouse.x)*15;
						mouseVelY=(lastMouseY-mouse.y)*15;
						lastMouseX=mouse.x;
						lastMouseY=mouse.y;
						console.log("mouseVelX:"+mouseVelX+" mouseVelY:"+mouseVelY);
						if(currentApp=="sm"){
							statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]=statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]+mouseVelX;
							statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]=statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]-mouseVelY;	
						}	
						if(currentApp=="fm"){
							fm_statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]=fm_statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]+mouseVelX;
							fm_statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]=fm_statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]-mouseVelY;	
						}
						syncObjectsToJson();
						displayObjects[globalController.selectedObject].updateCorners();
					}
				}

				if(fineMappingEnabled==false){
					uniforms1.mousey={ value: mouse.y };
					uniforms2.mousey={ value: mouse.y };
					uniforms1.mousex={ value: mouse.x };
					uniforms2.mousex={ value: mouse.x };
					raycaster.setFromCamera( mouse, camera );
					if ( SELECTED ) {
						
						if ( raycaster.ray.intersectPlane( plane, intersection ) ) {
							if (SELECTED.name.indexOf('vertice') != -1 && SELECTED.name.indexOf('corner') == -1) {
								console.log(SELECTED.name)
								SELECTED.position.copy(intersection.sub( offset ));
								SELECTED.parent.geometry.vertices[SELECTED.name.substring(SELECTED.name.indexOf("ce")+2,SELECTED.name.length)].x=SELECTED.position.x;
								SELECTED.parent.geometry.vertices[SELECTED.name.substring(SELECTED.name.indexOf("ce")+2,SELECTED.name.length)].y=SELECTED.position.y;
								SELECTED.parent.geometry.verticesNeedUpdate = true;
								if(currentApp=="sm"){
									statesArray[parseInt(globalController.selectedObject)]["VerticeX"+SELECTED.vertNum]=SELECTED.position.x;						
									statesArray[parseInt(globalController.selectedObject)]["VerticeY"+SELECTED.vertNum]=SELECTED.position.y;	
								}	
								if(currentApp=="fm"){
									fm_statesArray[parseInt(globalController.selectedObject)]["VerticeX"+SELECTED.vertNum]=SELECTED.position.x;						
									fm_statesArray[parseInt(globalController.selectedObject)]["VerticeY"+SELECTED.vertNum]=SELECTED.position.y;	
								}				
							}
						}
						return;
					}
					var intersects = raycaster.intersectObjects( objects);
					if ( intersects.length > 0 ) {
						if ( INTERSECTED != intersects[ 0 ].object ) {
							INTERSECTED = intersects[ 0 ].object;
							plane.setFromNormalAndCoplanarPoint(
								camera.getWorldDirection( plane.normal ),
								INTERSECTED.position );
						}
						container.style.cursor = 'pointer';
					} else {
						INTERSECTED = null;
						container.style.cursor = 'auto';
					}
				}
			}

			function onDocumentTouchStart(event){
				if(fineMappingEnabled==true){
					mouseIsDown=true;
					lastMouseX = ( event.touches[0].clientX / window.innerWidth ) * 2.0 - 1.0;
					lastMouseY = - ( event.touches[0].clientY / window.innerHeight ) * 2.0 + 1.0;
				}

				mouse.x = ( event.touches[0].clientX / window.innerWidth ) * 2.0 - 1.0;
                mouse.y = - ( event.touches[0].clientY / window.innerHeight ) * 2.0 + 1.0;
				if(fineMappingEnabled==false){
					requestFullScreen();
					raycaster.setFromCamera( mouse, camera );
					intersects = raycaster.intersectObjects( objects);
					if ( intersects.length > 0 ) {
						SELECTED = intersects[ 0 ].object;
						if ( raycaster.ray.intersectPlane( plane, intersection ) ) {
							offset.copy( intersection ).sub( SELECTED.position );
						}
						container.style.cursor = 'move';
					}
					if (SELECTED) {
						if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
							// console.log(SELECTED)
							SELECTED.parent.updateCorners();

							var listOfCornerVertices=[4,0,20,24];
							selectedVertice=listOfCornerVertices.indexOf(SELECTED.vertNum);
							// console.log("Selected Vertice:"+selectedVertice);
							highlightSelectedVertice();
						}
					}	
				}
			}

            function onDocumentTouchEnd(event){
				if(fineMappingEnabled==true){
					mouseIsDown=false;
				}
				SELECTED = null;
				//event.preventDefault();
				if (SELECTED) {
					if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
						SELECTED.parent.updateCorners();
					}
				}
				
				container.style.cursor = 'auto';
			}
				         			
			function onDocumentMouseMove( event ) {
				if(fineMappingEnabled==false){
					if (SELECTED) {
						if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
							console.log(SELECTED)
							SELECTED.parent.updateCorners();
						}
					}
				}
				
				mouse.x = ( event.clientX / window.innerWidth ) * 2.0 - 1.0;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2.0 + 1.0;

				if(fineMappingEnabled==true){
					if(mouseIsDown==true){
						mouseVelX=(lastMouseX-mouse.x)*50;
						mouseVelY=(lastMouseY-mouse.y)*50;
						lastMouseX=mouse.x;
						lastMouseY=mouse.y;
						console.log("mouseVelX:"+mouseVelX+" mouseVelY:"+mouseVelY);
						if(currentApp=="sm"){
							statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]=statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]+mouseVelX;
							statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]=statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]-mouseVelY;	
						}	
						if(currentApp=="fm"){
							fm_statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]=fm_statesArray[globalController.selectedObject]["VerticeX"+listOfCornerVertices[selectedVertice]]+mouseVelX;
							fm_statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]=fm_statesArray[globalController.selectedObject]["VerticeY"+listOfCornerVertices[selectedVertice]]-mouseVelY;	
						}	
						syncObjectsToJson();
						displayObjects[globalController.selectedObject].updateCorners();
					}
				}

				if(fineMappingEnabled==false){
					uniforms1.mousey={ value: mouse.y };
					uniforms2.mousey={ value: mouse.y };
					uniforms1.mousex={ value: mouse.x };
					uniforms2.mousex={ value: mouse.x };
					raycaster.setFromCamera( mouse, camera );
					if ( SELECTED ) {
						
						if ( raycaster.ray.intersectPlane( plane, intersection ) ) {
							if (SELECTED.name.indexOf('vertice') != -1 && SELECTED.name.indexOf('corner') == -1) {
								console.log(SELECTED.name)
								SELECTED.position.copy(intersection.sub( offset ));
								SELECTED.parent.geometry.vertices[SELECTED.name.substring(SELECTED.name.indexOf("ce")+2,SELECTED.name.length)].x=SELECTED.position.x;
								SELECTED.parent.geometry.vertices[SELECTED.name.substring(SELECTED.name.indexOf("ce")+2,SELECTED.name.length)].y=SELECTED.position.y;
								SELECTED.parent.geometry.verticesNeedUpdate = true;
								if(currentApp=="sm"){
									statesArray[parseInt(globalController.selectedObject)]["VerticeX"+SELECTED.vertNum]=SELECTED.position.x;						
									statesArray[parseInt(globalController.selectedObject)]["VerticeY"+SELECTED.vertNum]=SELECTED.position.y;	
								}	
								if(currentApp=="fm"){
									fm_statesArray[parseInt(globalController.selectedObject)]["VerticeX"+SELECTED.vertNum]=SELECTED.position.x;						
									fm_statesArray[parseInt(globalController.selectedObject)]["VerticeY"+SELECTED.vertNum]=SELECTED.position.y;	
								}		
								SELECTED.parent.updateCorners();	
							}
						}
						return;
					}
					var intersects = raycaster.intersectObjects( objects);
					if ( intersects.length > 0 ) {
						if ( INTERSECTED != intersects[ 0 ].object ) {
							INTERSECTED = intersects[ 0 ].object;
							plane.setFromNormalAndCoplanarPoint(
								camera.getWorldDirection( plane.normal ),
								INTERSECTED.position );
						}
						container.style.cursor = 'pointer';
					} else {
						INTERSECTED = null;
						container.style.cursor = 'auto';
					}
				}
			}
			
			function onDocumentMouseDown( event ) {
				if(fineMappingEnabled==true){
					mouseIsDown=true;
					lastMouseX = ( event.clientX / window.innerWidth ) * 2.0 - 1.0;
					lastMouseY = - ( event.clientY / window.innerHeight ) * 2.0 + 1.0;
				}
				if(fineMappingEnabled==false){
					raycaster.setFromCamera( mouse, camera );
					intersects = raycaster.intersectObjects( objects);
					if ( intersects.length > 0 ) {
						SELECTED = intersects[ 0 ].object;
						if ( raycaster.ray.intersectPlane( plane, intersection ) ) {
							offset.copy( intersection ).sub( SELECTED.position );
						}
						container.style.cursor = 'move';
					}
					if (SELECTED) {
						if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
							// console.log(SELECTED)
							SELECTED.parent.updateCorners();

							var listOfCornerVertices=[4,0,20,24];
							selectedVertice=listOfCornerVertices.indexOf(SELECTED.vertNum);
							// console.log("Selected Vertice:"+selectedVertice);
							highlightSelectedVertice();
						}
					}
				}
			}
			
			function onDocumentMouseUp( event ) {
				if(fineMappingEnabled==true){
					mouseIsDown=false;
				}
				//event.preventDefault();
				if (SELECTED) {
					if (SELECTED.isCorner==true && globalController.mappingMode<.5) {
						SELECTED.parent.updateCorners();
					}
				}
				SELECTED = null;
				container.style.cursor = 'auto';
			}
				
			function animate() {
			    // if(painterController.ColorMix != 0){
				// 	colorCounter=colorCounter+painterController.ColorRate
				// 	if(colorCounter > 1){
				// 		colorCounter=0;
				// 		clr.change();
				// 	}
			    // }
				requestAnimationFrame( animate );
				render();
			}
			
			function render() {
				uniforms1[ "time" ].value += .01 * 5;
				uniforms2[ "time" ].value += .01 * 5;
				uniforms1[ "brightness" ].value=globalController.BrightnessA;
				uniforms2[ "brightness" ].value=globalController.BrightnessB;
				for(var x=0;x<displayObjects.length;x++){
					displayObjects[x].material.transparent=true
					displayObjects[x].material.needsUpdate=true
				}
				renderer.render( scene, camera );
			}
			
			function requestFullScreen() {
				// Supports most browsers and their versions.
				var element = document.body; // Make the body go full screen.
				var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			
				if (requestMethod) { // Native full screen.
					requestMethod.call(element);
				} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
					var wscript = new ActiveXObject("WScript.Shell");
					if (wscript !== null) {
						wscript.SendKeys("{F11}");
					}
				}
			}
		
			function saveState(){
				if(currentApp=="sm"){
					globalState.BrightnessA=document.getElementById("slider1a").value/1000;
					globalState.BrightnessB=document.getElementById("slider1b").value/1000;
					globalState.DMX_Brightness=document.getElementById("slider2").value/1000;
					globalState.DMX_Pattern_Rate=document.getElementById("slider3").value/1000;
					globalState.VolumeThreshold=document.getElementById("slider4").value/1000;
					globalState.SavedByController=true;
					var requestBody=JSON.stringify({"storage" : statesArray, "global": globalState})
					var xmlhttp=new XMLHttpRequest();
					xmlhttp.open("POST", "../php/write.php?fn=globalPresets/"+globalController.PresetName+".txt", true);
				}else{				
					var requestBody=JSON.stringify({"storage" : fm_statesArray, "storage2": fm_globalState, "SavedByController": true, "SceneRate": document.getElementById("SceneRate").value/1000 })
					var xmlhttp=new XMLHttpRequest();
					xmlhttp.open("POST", "../php/write.php?fn=flowMapperPresets/Preset_1.txt", true);
				}
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log(xmlhttp.response.status);
					setTimeout(function(){
						if(isMidPresetChange==false){
							setTimeout(function(){
								saveState();
							}, 200);
						}
					}, 125);
				}
			}
			
			function recallState(isResetToDefault){
				var xmlhttp=new XMLHttpRequest();
				if(isResetToDefault==true){
					xmlhttp.open("GET", "../php/read.php?fn=globalPresets/DefaultPreset.txt", true);
				}else{
					xmlhttp.open("GET", "../php/read.php?fn=globalPresets/"+globalController.PresetName+".txt", true);
				}
				xmlhttp.send();
				xmlhttp.onload = function(e){

					globalState=JSON.parse(xmlhttp.response).global;
					if(globalState.SavedByController==false){
						var temp=JSON.parse(xmlhttp.response).storage;
						for(var x=0; x<4; x++){
							for(var y=0; y<25; y++){
								// temp[x]["VerticeX"+y]=temp[x]["VerticeX"+y]-window.innerWidth*.04;
								// temp[x]["VerticeY"+y]=temp[x]["VerticeY"+y]+window.innerHeight*.09;
								temp[x]["VerticeX"+y]=temp[x]["VerticeX"+y]/2;
								temp[x]["VerticeY"+y]=temp[x]["VerticeY"+y]/2;

							}						
						}
						statesArray=temp;
					}else{
						statesArray=JSON.parse(xmlhttp.response).storage
					}			

					syncObjectsToJson(true);
					if(initControllerDone==false){
						initController();
					}
					if(isMidPresetChange==true){
						isMidPresetChange=false;
						updateControllerView();
						saveState();
					}
					changeMask(1);
					changeMask(2);
					document.getElementById("xyHandleElement").style.left=parseInt(globalState.xyPadX/1.1*window.innerWidth)+"px";
					document.getElementById("xyHandleElement").style.top=parseInt(globalState.xyPadY/1.5*window.innerHeight)+"px";
					if(isResetToDefault==true){
						resetToDefaultAllPresets(1);
					}
				}
			}	
			
			function saveMapForAllPresets(destinationPresetNumber){
				if(destinationPresetNumber<9){
					var xmlhttp=new XMLHttpRequest();
					xmlhttp.open("GET", "../php/read.php?fn=globalPresets/GlobalPreset"+destinationPresetNumber+".txt", true);
					xmlhttp.send();
					xmlhttp.onload = function(e){
						var tempAllStates=JSON.parse(xmlhttp.response);
						for(var x=0; x<4; x++){
							for(var y=0; y<25; y++){
								tempAllStates.storage[x]["VerticeX"+y]=statesArray[x]["VerticeX"+y];
								tempAllStates.storage[x]["VerticeY"+y]=statesArray[x]["VerticeY"+y];

							}
							tempAllStates.storage[x].ZValue=statesArray[x].ZValue;
							tempAllStates.storage[x].Visible=statesArray[x].Visible;
							tempAllStates.storage[x].Shader=statesArray[x].Shader;
						}
						tempAllStates.global.SavedByController=true;
						// tempAllStates.global.DMX_X1=globalState.DMX_X1;
						// tempAllStates.global.DMX_Y1=globalState.DMX_Y1;
						// tempAllStates.global.DMX_X2=globalState.DMX_X2;
						// tempAllStates.global.DMX_Y2=globalState.DMX_Y2;
						tempAllStates.global.MaskA=globalState.MaskA;
						tempAllStates.global.MaskB=globalState.MaskB;
						
						var xmlhttp2=new XMLHttpRequest();
						xmlhttp2.open("POST", "../php/write.php?fn=globalPresets/GlobalPreset"+destinationPresetNumber+".txt", true);
						xmlhttp2.send(JSON.stringify(tempAllStates));
						xmlhttp2.onload = function(e){
							saveMapForAllPresets(destinationPresetNumber+1);
						}
					}
				}
			}
	
			function saveDMXOverridesForAllPresets(destinationPresetNumber){
				if(destinationPresetNumber<9){
					var xmlhttp=new XMLHttpRequest();
					xmlhttp.open("GET", "../php/read.php?fn=globalPresets/GlobalPreset"+destinationPresetNumber+".txt", true);
					xmlhttp.send();
					xmlhttp.onload = function(e){
						var tempAllStates=JSON.parse(xmlhttp.response);
						tempAllStates.global.SavedByController=true;
						tempAllStates.global.DMX_X1=globalState.DMX_X1;
						tempAllStates.global.DMX_Y1=globalState.DMX_Y1;
						tempAllStates.global.DMX_X2=globalState.DMX_X2;
						tempAllStates.global.DMX_Y2=globalState.DMX_Y2;
						
						var xmlhttp2=new XMLHttpRequest();
						xmlhttp2.open("POST", "../php/write.php?fn=globalPresets/GlobalPreset"+destinationPresetNumber+".txt", true);
						xmlhttp2.send(JSON.stringify(tempAllStates));
						xmlhttp2.onload = function(e){
							saveDMXOverridesForAllPresets(destinationPresetNumber+1);
						}
					}
				}
			}
	
	        function getNumberOfShadersAndPresets(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=fragmentShaders/numberOfShaders.txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
                    numberOfShaders=parseInt(xmlhttp.response);
                    console.log("get number of shaders: "+numberOfShaders)			
				}
				var xmlhttp2=new XMLHttpRequest();
				xmlhttp2.open("GET", "../php/read.php?fn=dmxPresets/numberOfPatterns.txt", true);
				xmlhttp2.send();
				xmlhttp2.onload = function(e){
                    numberOfDMXPatterns=parseInt(xmlhttp2.response);
                    console.log("get number of dmx patterns: "+numberOfDMXPatterns);
				}
				var xmlhttp3=new XMLHttpRequest();
				xmlhttp3.open("GET", "../php/read.php?fn=masks/numberOfMasks.txt", true);
				xmlhttp3.send();
				xmlhttp3.onload = function(e){
                    numberOfMasks=parseInt(xmlhttp3.response);
                    console.log("get number of masks: "+numberOfMasks)			
				}
				var xmlhttp4=new XMLHttpRequest();
				xmlhttp4.open("GET", "../php/read.php?fn=dmxPresets/pattern0.txt", true);
				xmlhttp4.send();
				xmlhttp4.onload = function(e){
                    listOfGuardedChannels=xmlhttp4.response.split(",");
					for (var x=0; x<listOfGuardedChannels.length; x++){
						listOfGuardedChannels[x]=parseInt(listOfGuardedChannels[x]);
					}
                    console.log("get list of guarded channels: "+listOfGuardedChannels)				
				}
            }
		
			function getCanvasYFlip(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=misc/canvasYFlip.txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
					var yFlipValue=parseInt(xmlhttp.response);
					console.log("Got Y Flip Value: "+yFlipValue);
					document.getElementsByTagName('canvas')[0].style.transform='scale(1,'+yFlipValue+')';
				}
			}
		
			function initController(){
				document.getElementById('VJ_Button').style.backgroundColor='grey';
				createGrid("A");
					createGrid("B");
					createDMXGrid();
					createPresetsGrid();
					document.getElementById("slider1a").value=globalState.BrightnessA*1000;
					document.getElementById("slider1b").value=globalState.BrightnessB*1000;
					document.getElementById("slider2").value=globalState.DMX_Brightness*1000;
					document.getElementById("slider3").value=globalState.DMX_Pattern_Rate*1000;
					document.getElementById("slider4").value=globalState.VolumeThreshold*1000;
					initControllerDone=true;
					saveControllerState();
			}

			function selectPage(buttonElement){
				requestFullScreen();
				console.log("Selected Page:"+buttonElement.id)
				document.getElementById('Misc_Button').style.backgroundColor='black';
				document.getElementById('VJ_Button').style.backgroundColor='black';
				document.getElementById('Mapping_Button').style.backgroundColor='black';
				document.getElementById('FM_Button').style.backgroundColor='black';
				buttonElement.style.backgroundColor='grey';
				if(buttonElement.id=="Misc_Button"){
					clearVJ();
					clearFM();
					clearMapping();
					showMenu();
				}else if(buttonElement.id=="VJ_Button"){
					clearMenu();
					clearFM();
					clearMapping();
					showVJ();
				}else if(buttonElement.id=="Mapping_Button"){
					clearVJ();
					clearMenu();
					clearFM();
					showMapping();
				}else if(buttonElement.id=="FM_Button"){
					clearVJ();
					clearMenu();
					clearMapping();
					showFM();
				}
				function clearVJ(){
					document.getElementById('dmxPageSelectorContainer').style.display='none';
					document.getElementById('grid-container-A').style.display='none';
					document.getElementById('grid-container-B').style.display='none';
					document.getElementById('mask-container-A').style.display='none';
					document.getElementById('mask-container-B').style.display='none';
					document.getElementById('slider-container').style.display='none';
					document.getElementById('dmx-grid-container').style.display='none';	
					document.getElementById('dmx-overrides-container').style.display='none';	
					document.getElementById('dmx-misc-container').style.display='none';	
					document.getElementById('sectionLabelA').style.display='none';	
					document.getElementById('sectionLabelB').style.display='none';	
					document.getElementById('sectionLabelC').style.display='none';	
					document.getElementById('sectionLabelD').style.display='none';	
					document.getElementById('presets-grid-container').style.display='none';	
					document.getElementById("mapping_mode_right_border").style.display="none";
				}
				function showVJ(){
					setCurrentApp("sm");
					setTimeout(function(){forceInitControllerMode();},2000);
					document.getElementById('dmxPageSelectorContainer').style.display='grid';
					document.getElementById('grid-container-A').style.display='grid';
					document.getElementById('grid-container-B').style.display='grid';
					document.getElementById('mask-container-A').style.display='grid';
					document.getElementById('mask-container-B').style.display='grid';
					document.getElementById('slider-container').style.display='grid';
					if(currentDMXPage=="presets"){
						document.getElementById('dmx-grid-container').style.display='grid';	
						document.getElementById('dmx-overrides-container').style.display='none';
						document.getElementById("dmx-misc-container").style.display="none";	
					}
					if(currentDMXPage=="overrides"){
						document.getElementById('dmx-grid-container').style.display='none';	
						document.getElementById('dmx-overrides-container').style.display='grid';
						document.getElementById("dmx-misc-container").style.display="none";
					}
					if(currentDMXPage=="misc"){
						document.getElementById('dmx-grid-container').style.display='none';	
						document.getElementById('dmx-overrides-container').style.display='none';
						document.getElementById("dmx-misc-container").style.display="grid";
					}
					document.getElementById('sectionLabelA').style.display='grid';	
					document.getElementById('sectionLabelB').style.display='grid';	
					document.getElementById('sectionLabelC').style.display='grid';	
					document.getElementById('sectionLabelD').style.display='grid';	
					document.getElementById('presets-grid-container').style.display='grid';		
					document.getElementById("mapping_mode_right_border").style.display="block";
				}
				function clearMenu(){
					document.getElementById('misc_page').style.display='none';
					document.getElementById('presets-grid-container').style.display='none';		

				}
				function showMenu(){
					document.getElementById('misc_page').style.display='block';
					document.getElementById('presets-grid-container').style.display='grid';		
					if(currentApp=="sm"){
						document.getElementById('VJ_Button').style.backgroundColor='darkblue';
					}
					if(currentApp=="fm"){
						document.getElementById('FM_Button').style.backgroundColor='darkblue';
					}

				}
				function clearFM(){
					document.getElementById('fm_page').style.display='none';
					document.getElementById('presets-grid-container').style.display='none';		
					document.getElementById('fm-scene-grid-container').style.display='none';
				}
				function showFM(){
					setCurrentApp("fm");
					setTimeout(function(){forceInitControllerMode();},2000);
					getCurrentFMScene();
					document.getElementById('fm_page').style.display='grid';
					document.getElementById('fm-scene-grid-container').style.display='grid';
				}
				function clearMapping(){
					document.getElementById('mapping_page').style.display='none';
					renderer.domElement.style.display="none";
					renderer.domElement.style.zIndex=-1;
					document.getElementById('mapping-controls-grid-container').style.display='none';
					document.getElementById('mapping-controls-grid-container-top').style.display='none';
					document.getElementById("mapping_mode_right_border").style.display="none";
				}
				function showMapping(){
					document.getElementById('mapping_page').style.display='block';
					renderer.domElement.style.display="block";
					renderer.domElement.style.zIndex=0;
					document.getElementById('mapping-controls-grid-container').style.display='grid';
					document.getElementById('mapping-controls-grid-container-top').style.display='grid';
					selectObject( globalController.selectedObject, "mapping-controls-grid-item-"+parseInt(globalController.selectedObject+1) );
					document.getElementById("mapping_mode_right_border").style.display="block";
					if(currentApp=="sm"){
						document.getElementById("mapping-controls-selected-shader").style.display="block"
						document.getElementById("mapping-controls-grid-container").style.gridTemplateColumns="10% 5% 5% 5% 5% 10% 10% 10% 10% 20% 10%"
						document.getElementById("duplicateSaveMap").style.display="block"
						document.getElementById("mapping-controls-grid-container-top").style.gridTemplateColumns="20% 10% 10% 10% 10% 40%"
						document.getElementById('VJ_Button').style.backgroundColor='darkblue';
					}
					if(currentApp=="fm"){
						document.getElementById("mapping-controls-selected-shader").style.display="none"
						document.getElementById("mapping-controls-grid-container").style.gridTemplateColumns="10% 5% 5% 5% 5% 10% 20% 10% 20% 10%"
						document.getElementById("duplicateSaveMap").style.display="none"
						document.getElementById("mapping-controls-grid-container-top").style.gridTemplateColumns="20% 20% 20% 20% 20%"
						document.getElementById('FM_Button').style.backgroundColor='darkblue';
					}
				}
			}

			function setCurrentApp(appInitials){
				currentApp=appInitials;
				syncObjectsToJson();
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/write.php?fn=globalPresets/currentApp.txt", true);
				xmlhttp.send(appInitials);
				xmlhttp.onload = function(e){
					console.log("setCurrentApp:"+appInitials);
				}
			}
			
			function createGrid(deck){
				if(deck=="A"){
					var gridContainer=document.getElementById("grid-container-A")
					var maskContainer=document.getElementById("mask-container-A")
				}else{
					var gridContainer=document.getElementById("grid-container-B")
					var maskContainer=document.getElementById("mask-container-B")
				}
				for(var x=1; x<=52; x++){
					var gridItem=document.createElement('button')
					gridItem.id="GridItem"+x+"_Deck"+deck;
					gridItem.deck=deck;
					gridItem.shaderNumber=x;
					gridItem.style.backgroundImage="url('fragmentShaderIcons/shader"+parseInt(x)+".png')";
					gridItem.style.backgroundPosition="center";
					gridItem.style.backgroundSize="cover";
					gridItem.style.borderColor="black";
					gridItem.class="grid-item";
					gridItem.onclick=function(){selectShader(this.shaderNumber,this.deck)};
					if(parseInt(globalState["Shader"+deck])==x){
						gridItem.style.opacity=".2"
					}else{
						gridItem.style.opacity="1.0"
					}
					gridContainer.appendChild(gridItem);
				}
				for(var x=1; x<=7; x++){
					var maskItem=document.createElement('button')
					maskItem.id="MaskItem"+x+"_Deck"+deck;
					maskItem.deck=deck;
					maskItem.maskNumber=x;
					maskItem.style.backgroundImage="url('maskIcons/mask"+parseInt(x)+".jpg')";
					maskItem.style.backgroundPosition="center";
					maskItem.style.backgroundSize="contain";
					maskItem.style.backgroundRepeat="no-repeat";
					maskItem.style.backgroundColor="#000000"
					maskItem.style.borderColor="black";
					maskItem.class="grid-item";
					maskItem.onclick=function(){selectMask(this.maskNumber,this.deck)};
					if(parseInt(globalState["Mask"+deck])==x){
						maskItem.style.opacity=".2"
					}else{
						maskItem.style.opacity="1.0"
					}
					maskContainer.appendChild(maskItem);
				}
			}

			function createDMXGrid(){
				var gridContainer=document.getElementById("dmx-grid-container")
				for(var x=1; x<=16; x++){
					var gridItem=document.createElement('button')
					gridItem.id="DMXGridItem"+x;
					gridItem.dmxPatternNumber=x;
					gridItem.style.borderColor="black";
					gridItem.style.backgroundColor="grey";
					gridItem.class="grid-item";
					gridItem.onclick=function(){selectDMXPreset(this.dmxPatternNumber)};
					gridItem.innerHTML=x;
					if(parseInt(globalState.DMX_Pattern)==x){
						gridItem.style.backgroundColor="darkgrey"
					}else{
						gridItem.style.backgroundColor="grey"
					}
					gridContainer.appendChild(gridItem);
				}
			}
			
			function createPresetsGrid(){
				var presetGridContainer=document.getElementById("presets-grid-container")
				var labelItem=document.createElement('button');
				labelItem.id="presetGridLabel"
				labelItem.style.borderColor="grey";
				labelItem.style.backgroundColor="black";
				labelItem.innerHTML="Global Presets:";
				labelItem.style.color="white";
				labelItem.style.fontSize=".5em";
				labelItem.style.textDecoration="underline";
				presetGridContainer.appendChild(labelItem);
				for(var x=1; x<=8; x++){
					var gridItem=document.createElement('button')
					gridItem.id="PresetsGridItem"+x;
					gridItem.presetNumber=x;
					gridItem.style.borderColor="grey";
					gridItem.innerHTML=x;
					if(x==parseInt(globalController.PresetName.substring(globalController.PresetName.length-1,globalController.PresetName.length))){
						gridItem.style.backgroundColor="grey"
					}else{
						gridItem.style.backgroundColor="black"
					}
					gridItem.style.color="white";
					gridItem.style.fontSize=".5em";
					gridItem.class="grid-item";
					gridItem.onclick=function(){selectGlobalPreset(this.presetNumber)};
					gridItem.innerHTML=parseInt(x);
					presetGridContainer.appendChild(gridItem);
				}
			}

			function selectShader(shaderNumber,deck){
				for(var x=1; x<=52; x++){
					if(parseInt(shaderNumber)==x){
						document.getElementById("GridItem"+x+"_Deck"+deck).style.opacity=".2"
					}else{
						document.getElementById("GridItem"+x+"_Deck"+deck).style.opacity="1.0"
					}
				}
				globalState["Shader"+deck]=shaderNumber;
				console.log("ShaderNumber:"+shaderNumber+" Deck:"+deck);
			}

			function selectMask(maskNumber,deck){
				for(var x=1; x<=7; x++){
					if(parseInt(maskNumber)==x){
						document.getElementById("MaskItem"+x+"_Deck"+deck).style.opacity=".2"
					}else{
						document.getElementById("MaskItem"+x+"_Deck"+deck).style.opacity="1.0"
					}
				}
				globalState["Mask"+deck]=maskNumber;
				console.log("MaskNumber:"+maskNumber+" Deck:"+deck);
				changeMask(1);
				changeMask(2);
			}

			function selectDMXPreset(dmxPatternNumber){
				for(var x=1; x<=16; x++){
					if(parseInt(dmxPatternNumber)==x){
						document.getElementById("DMXGridItem"+x).style.backgroundColor="darkgrey"
					}else{
						document.getElementById("DMXGridItem"+x).style.backgroundColor="grey"
					}
				}
				globalState.DMX_Pattern=dmxPatternNumber;
			}

			function getCurrentPresetName(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=globalPresets/currentPreset.txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
					globalController.PresetName="GlobalPreset"+parseInt(xmlhttp.response);
					recallState(false);
				}
			}

			function initController(){
				document.getElementById('VJ_Button').style.backgroundColor='grey';
				createGrid("A");
				createGrid("B");
				createDMXGrid();
				createPresetsGrid();
				initControllerDone=true;
				updateControllerView();
				saveState();
			}

			function updateControllerView(){
				for(var x=1; x<=52; x++){
					if(parseInt(globalState.ShaderA)==x){
						document.getElementById("GridItem"+x+"_DeckA").style.opacity=".2"
					}else{
						document.getElementById("GridItem"+x+"_DeckA").style.opacity="1.0"
					}
				}
				for(var x=1; x<=52; x++){
					if(parseInt(globalState.ShaderB)==x){
						document.getElementById("GridItem"+x+"_DeckB").style.opacity=".2"
					}else{
						document.getElementById("GridItem"+x+"_DeckB").style.opacity="1.0"
					}
				}
				for(var x=1; x<=7; x++){
					if(parseInt(globalState.MaskA)==x){
						document.getElementById("MaskItem"+x+"_DeckA").style.opacity=".2"
					}else{
						document.getElementById("MaskItem"+x+"_DeckA").style.opacity="1.0"
					}
				}
				for(var x=1; x<=7; x++){
					if(parseInt(globalState.MaskB)==x){
						document.getElementById("MaskItem"+x+"_DeckB").style.opacity=".2"
					}else{
						document.getElementById("MaskItem"+x+"_DeckB").style.opacity="1.0"
					}
				}
				for(var x=1; x<=16; x++){
					if(parseInt(globalState.DMX_Pattern)==x){
						document.getElementById("DMXGridItem"+x).style.backgroundColor="darkgrey"
					}else{
						document.getElementById("DMXGridItem"+x).style.backgroundColor="grey"
					}
				}
				document.getElementById("slider1a").value=globalState.BrightnessA*1000;
				document.getElementById("slider1b").value=globalState.BrightnessB*1000;
				document.getElementById("slider2").value=globalState.DMX_Brightness*1000;
				document.getElementById("slider3").value=globalState.DMX_Pattern_Rate*1000;
				document.getElementById("slider4").value=globalState.VolumeThreshold*1000;
				document.getElementById("dmxOverrideSlider1").value=globalState.DMX_X1*10;
				document.getElementById("dmxOverrideSlider2").value=globalState.DMX_Y1*10;
				document.getElementById("dmxOverrideSlider3").value=globalState.DMX_X2*10;
				document.getElementById("dmxOverrideSlider4").value=globalState.DMX_Y2*10;
			}
		
			function selectGlobalPreset(presetNumber){
				globalController.PresetName="GlobalPreset"+parseInt(presetNumber);
				isMidPresetChange=true;
				recallState(false);
				for(var x=1; x<=8; x++){
					if(parseInt(presetNumber)==x){
						document.getElementById("PresetsGridItem"+x).style.backgroundColor="grey"
						console.log("Setting currentPreset to: "+parseInt(presetNumber));
						setCurrentPresetNumber(parseInt(presetNumber));
					}else{
						document.getElementById("PresetsGridItem"+x).style.backgroundColor="black"
					}
				}
			}
		
			function setCurrentPresetNumber(presetNumber){
				globalController.PresetName="GlobalPreset"+presetNumber;
				var requestBody=parseInt(presetNumber);
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/write.php?fn=globalPresets/currentPreset.txt", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log("Changed current preset number")
				}
			}

			function highlightSelectedVertice(){
				listOfCornerVertices=[4,0,20,24];
				console.log(selectedVertice)
				for(var y=0; y<displayObjects.length; y++){
					for(var x=0; x<4; x++){
						if(parseInt(x)==parseInt(selectedVertice)){
							displayObjects[y].children[listOfCornerVertices[x]].material.color={"r":1.0, "g":0.0, "b":1.0}
						}else{
							displayObjects[y].children[listOfCornerVertices[x]].material.color={"r":1.0, "g":1.0, "b":1.0}
						}
					}
				}
				for(var x=1; x<5; x++){
					if(parseInt(x-1)==parseInt(selectedVertice)){
						document.getElementById("selectVertice"+x).style.backgroundColor="grey"
					}else{
						document.getElementById("selectVertice"+x).style.backgroundColor="black"
					}
				}
			}
		
			function setCurrentFMScene(sceneNum, buttonElem){
				var xmlhttp=new XMLHttpRequest();
				currentFMScene=sceneNum;
				xmlhttp.open("POST", "../php/write.php?fn=flowMapperPresets/currentScene.txt", true);
				xmlhttp.send(sceneNum);
				xmlhttp.onload = function(e){
					console.log("setCurrentFMScene:"+sceneNum);
					var elemsList=document.getElementsByClassName("fm-scene-grid-container-item");
					for(var x=1; x<elemsList.length; x++){
						elemsList[x].style.backgroundColor="black";
					}
					buttonElem.style.backgroundColor="grey";
					document.getElementById("BrightnessSensitivity").value=fm_globalState[currentFMScene].BrightnessSensitivity*1000;
					document.getElementById("ColorHop").value=fm_globalState[currentFMScene].ColorHop*100;
					document.getElementById("ColorMix").value=fm_globalState[currentFMScene].ColorMix*1000;
					document.getElementById("ColorRate").value=fm_globalState[currentFMScene].ColorRate*1000;
					document.getElementById("FadeTime").value=fm_globalState[currentFMScene].FadeTime*1000;
					document.getElementById("KaleidoScope").value=fm_globalState[currentFMScene].KaleidoScope;
					document.getElementById("VelocitySensitivity").value=fm_globalState[currentFMScene].VelocitySensitivity*1000;
				}
			}
			
			function getCurrentFMScene(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/read.php?fn=flowMapperPresets/currentScene.txt", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){
					console.log("getCurrentFMScene:"+parseInt(xmlhttp.response));
					currentFMScene=parseInt(xmlhttp.response);
					var elemsList=document.getElementsByClassName("fm-scene-grid-container-item");
					for(var x=1; x<elemsList.length; x++){
						elemsList[x].style.backgroundColor="black";
					}
					elemsList[(parseInt(xmlhttp.response)+1)].style.backgroundColor="grey";

					var xmlhttp2=new XMLHttpRequest();
					xmlhttp2.open("GET", "../php/read.php?fn=flowMapperPresets/Preset_1.txt", true);
					xmlhttp2.send();
					xmlhttp2.onload = function(e){
						fm_statesArray=JSON.parse(xmlhttp2.response).storage;
						fm_globalState=JSON.parse(xmlhttp2.response).storage2;

						if(JSON.parse(xmlhttp2.response).SavedByController==false){
							console.log("Not saved by controller, scaling now");
						// 	var temp=JSON.parse(xmlhttp.response).storage;
							for(var x=0; x<4; x++){
								for(var y=0; y<25; y++){
									// temp[x]["VerticeX"+y]=temp[x]["VerticeX"+y]-window.innerWidth*.04;
									// temp[x]["VerticeY"+y]=temp[x]["VerticeY"+y]+window.innerHeight*.09;
									fm_statesArray[x]["VerticeX"+y]=fm_statesArray[x]["VerticeX"+y]/2;
									fm_statesArray[x]["VerticeY"+y]=fm_statesArray[x]["VerticeY"+y]/2;

								}						
							}
						// 	fm_statesArray=temp;
						// }else{
						// 	fm_statesArray=JSON.parse(xmlhttp.response).storage
						}		


						document.getElementById("BrightnessSensitivity").value=fm_globalState[currentFMScene].BrightnessSensitivity*1000;
						document.getElementById("ColorHop").value=fm_globalState[currentFMScene].ColorHop*100;
						document.getElementById("ColorMix").value=fm_globalState[currentFMScene].ColorMix*1000;
						document.getElementById("ColorRate").value=fm_globalState[currentFMScene].ColorRate*1000;
						document.getElementById("FadeTime").value=fm_globalState[currentFMScene].FadeTime*1000;
						document.getElementById("KaleidoScope").value=fm_globalState[currentFMScene].KaleidoScope;
						document.getElementById("VelocitySensitivity").value=fm_globalState[currentFMScene].VelocitySensitivity*1000;

						syncObjectsToJson();
					}
				}
			}
		
			function updateFMState(){
				fm_globalState[currentFMScene].BrightnessSensitivity=document.getElementById("BrightnessSensitivity").value/1000;
				fm_globalState[currentFMScene].ColorHop=document.getElementById("ColorHop").value/100;
				fm_globalState[currentFMScene].ColorMix=document.getElementById("ColorMix").value/1000;
				fm_globalState[currentFMScene].ColorRate=document.getElementById("ColorRate").value/1000;
				fm_globalState[currentFMScene].FadeTime=document.getElementById("FadeTime").value/1000;
				fm_globalState[currentFMScene].KaleidoScope=document.getElementById("KaleidoScope").value;
				fm_globalState[currentFMScene].VelocitySensitivity=document.getElementById("VelocitySensitivity").value/1000;
			}
		
			function rebootPi(){
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET", "../php/reboot.php", true);
				xmlhttp.send();
				xmlhttp.onload = function(e){console.log(xmlhttp.response.status)}
			}
		
		</script>
	</body>
</html>

