<html>
	<head>
		<title>MaskUploader</title>
		<style>
			body{
				margin:20px;
				background-color:black;
			}
			#saveButton{
				width:48.25%;
				height:8%;
				position: absolute;
				top: 2%;
				left: 50.25%;
				background-color: grey;
			}
			#discardButton{
				width:48.25%;
				height:8%;
				position: absolute;
				top: 2%;
				left: 1.25%;
				background-color: grey;
			}
			#pictureButton{
				width:48.25%;
				height:8%;
				position: absolute;
				top: 2%;
				left: 1.25%;
				background-color: grey;
			}
			#exitButton{
				width:48.25%;
				height:8%;
				position: absolute;
				top: 2%;
				left: 50.25%;
				background-color: grey;
			}
			canvas{
				width:97%;
				height:73%;
				position: absolute;
				top: 11%;
				left: 1.25%;
				transform:scale(-1,1);
				display:none;
			}
			#chromaSlider{
				width:97%;
				height:9%;
				top:87%;
				left:1.25%;
				position: absolute;
				border:2.5px solid grey;
				-webkit-appearance: none;
				display:none;
				outline: none;
				opacity: 1;
				-webkit-transition: .2s;
				transition: opacity .2s;
				margin:0px;
				padding:0px;
				background-color: darkgrey;
			}
			#chromaSlider::-webkit-slider-thumb{
				-webkit-appearance: none;
				appearance: none;
				width: 40px;
				height: 100%;
				background: slategray;
				cursor: pointer;
				border-left:1px solid darkslategray;
				border-right:1px solid darkslategray;
			}
			#video {
				opacity: 1;
				width:97%;
				height:86.5%;
				top: 11%;
				left:1.25%;
				z-index:-1;
				transform:scale(-1,1);
				position:fixed;
				float:left;
				object-fit:fill;
				background-color: white;
			}
			button{
				font-size: 1.5em;
				outline: none;
			}
		</style>
	</head>
	<body>
		<video id="video" autoplay width="800" height="600" onclick="requestFullScreen();"></video>
		<button id="saveButton" onclick="saveCanvasData();" style="display:none">Save Image</button>
		<button id="pictureButton" onclick="takePicture();">Take Picture</button>
		<button id="discardButton" onclick="discardButtonClicked();" style="display:none">Discard Image</button>
		<button id="exitButton" onclick="window.location.href='http://'+location.host+'/controller/index.html'" style="">Exit / Back</button>
		<canvas id="mainCanvas" style="background-color: white;" onclick="requestFullScreen();"></canvas>
		<canvas id="iconImageCanvas" style="display: none;" width="800" height="600"></canvas>
		<canvas id="maskImageCanvas" style="display: none;" width="800" height="600"></canvas>
		<input id="chromaSlider" type="range" min="-255" max="255" value="0"  onchange="setMainCanvasChroma(event)" onmousemove="setMainCanvasChroma(event)">

		<script>

			initGlobalVars();
			function initGlobalVars(){
				// drawCanvasTestData();
				getVideo("init",0);
			}

			function resetImageMaskIconNeedsUpdate(){
				var requestBody="true";
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/write.php?fn=globalPresets/imageMaskIconNeedsUpdate.txt", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log("Set imageMaskNeedsUpdate")
				}
			}

			function resetImageMaskNeedsUpdate(){
				var requestBody="true";
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/write.php?fn=globalPresets/imageMaskNeedsUpdate.txt", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log("Set imageMaskNeedsUpdate")
				}
			}

			function drawCanvasTestData(){
				var canvas = document.getElementById('mainCanvas');
				var context = canvas.getContext('2d');
				context.beginPath();
				context.moveTo(50, 30);
				context.bezierCurveTo(80, 50, 80, 600, 230, 600);
				context.bezierCurveTo(250, 180, 200, 180, 200, 600);
				context.bezierCurveTo(100, 600, 200, 120, 200, 50);
				context.bezierCurveTo(100, 40, 100, 30, 100, 50);
				context.bezierCurveTo(100, 5, 100, 20, 200, 50);
				context.bezierCurveTo(200, 5, 120, 20, 170, 80);
				context.closePath();
				context.lineWidth = 5;
				context.fillStyle = '#8ED6FF';
				context.fill();
				context.strokeStyle = 'blue';
				context.stroke();
			}

			function saveCanvasData(){
				saveIconImage();
				saveMaskImage();
			}

			function saveIconImage(){
				var canvas = document.getElementById('iconImageCanvas');
				var requestBody=JSON.stringify(canvas.toDataURL());
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/writeBase64.php?fn=controller/maskIcons/mask7.jpg", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log(xmlhttp.response.status);
					resetImageMaskIconNeedsUpdate();
				}
			}

			function saveMaskImage(){
				var canvas = document.getElementById('maskImageCanvas');
				var requestBody=JSON.stringify(canvas.toDataURL());
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("POST", "../php/writeBase64.php?fn=masks/mask7.jpg", true);
				xmlhttp.send(requestBody);
				xmlhttp.onload = function(e){
					console.log(xmlhttp.response.status);
					resetImageMaskNeedsUpdate();
				}
			}
		  
			function getVideo(action,camNum) {
				if(action == "init"){
					numOfCameras=0
					cameraIds=[]
					selectedCamera=0;
					videoElem='video'
					navigator.mediaDevices.enumerateDevices().then(function(deviceInfos){
					  for (var i = 0; i !== deviceInfos.length; ++i) {
						var deviceInfo = deviceInfos[i];
						if (deviceInfo.kind === 'videoinput') {
						  numOfCameras=numOfCameras + 1
						  cameraIds.push(deviceInfo.deviceId);
						}
					  }
					  selectedCamera=camNum;
					  if (window.stream) {
						window.stream.getTracks().forEach(function(track) {
						  track.stop();
						});
					  }
					  //setTimeout(function(){ takePicture(); }, 5000);
					  setTimeout(function(){
					  if(numOfCameras>1){
							getVideo("select",1);
							document.getElementById("video").style.transform="scale(1,1)";
						}
					  },6000);
					  //console.log(cameraIds[selectedCamera])
					  var videoSource = cameraIds[selectedCamera];
					  var constraints = {video: {deviceId: videoSource ? {exact: videoSource} : undefined}};
					  navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
						  window.stream = stream; 
						  document.getElementById(videoElem).srcObject = stream;
						  return navigator.mediaDevices.enumerateDevices();
					  }).catch(function(error){
						  console.log('navigator.getUserMedia error: ', error);
					  });
					  }).catch(function(error){
						console.log('navigator.getUserMedia error: ', error);
					  });
				}
				if(action == "select"){
					selectedCamera=camNum;
					if (window.stream) {
					  window.stream.getTracks().forEach(function(track) {
						track.stop();
					  });
					}
					console.log(cameraIds[selectedCamera])
					var videoSource = cameraIds[selectedCamera];
					var constraints = {video: {deviceId: videoSource ? {exact: videoSource} : undefined}};
					navigator.mediaDevices.getUserMedia(constraints).then(function(stream){
						window.stream = stream; 
						document.getElementById(videoElem).srcObject = stream;
						return navigator.mediaDevices.enumerateDevices();
					}).catch(function(error){
						console.log('navigator.getUserMedia error: ', error);
					});
				}
			}	
		
			function takePicture(){
				var canvas = document.getElementById("mainCanvas");
				var context = canvas.getContext("2d");
				var video=document.getElementById("video");
				context.save();
				context.scale(-1,1);
				context.drawImage(video, 0, 0, -800, 600);
				context.restore();
				initialMainCanvasImgData=context.getImageData(0, 0, 800, 600);
				updateMaskImageCanvas();
				updateIconImageCanvas();
				setMainCanvasChroma({},true);
				document.getElementById("video").style.display="none";
				document.getElementById("pictureButton").style.display="none";
				document.getElementById("exitButton").style.display="none";
				document.getElementById("saveButton").style.display="block";
				document.getElementById("mainCanvas").style.display="block";
				document.getElementById("discardButton").style.display="block";
				document.getElementById("chromaSlider").style.display="inline";
			}

			function discardButtonClicked(){
				document.getElementById("video").style.display="block";
				document.getElementById("pictureButton").style.display="block";
				document.getElementById("saveButton").style.display="none";
				document.getElementById("exitButton").style.display="block";
				document.getElementById("mainCanvas").style.display="none";
				document.getElementById("discardButton").style.display="none";	
				document.getElementById("chromaSlider").style.display="none";			
			}

			function updateMaskImageCanvas(){
				var canvas = document.getElementById("maskImageCanvas");
				var context = canvas.getContext("2d");
				var video=document.getElementById("video");
				context.save();
				context.scale(-1,-1);
				context.drawImage(video, 0, 0, -800, -600);
				context.restore();
				initialMaskCanvasImgData=context.getImageData(0, 0, 800, 600);
			}

			function updateIconImageCanvas(){
				var canvas = document.getElementById("iconImageCanvas");
				var context = canvas.getContext("2d");
				var video=document.getElementById("video");
				context.save();
				context.scale(1,1);
				context.drawImage(video, 0, 0, 800, 600);
				context.restore();
				initialIconCanvasImgData=context.getImageData(0, 0, 800, 600);
			}
		
			function setMainCanvasChroma(event, wasTriggeredViaTakePicture){
				// console.log(event);
				if(wasTriggeredViaTakePicture==true){
					event.buttons=1;
					console.log("updating chroma after taking picture")
				}
				thresh=document.getElementById("chromaSlider").value;
				if(event.buttons!=0){

					var canvas = document.getElementById("mainCanvas");
					var context = canvas.getContext("2d");
					var imgData = context.getImageData(0, 0, 800, 600);
					context.putImageData(computeChroma(imgData, initialMainCanvasImgData, thresh), 0, 0);

					var canvas2 = document.getElementById("maskImageCanvas");
					var context2 = canvas2.getContext("2d");
					var imgData2 = context2.getImageData(0, 0, 800, 600);
					context2.putImageData(computeChroma(imgData2, initialMaskCanvasImgData, thresh), 0, 0);

					var canvas3 = document.getElementById("iconImageCanvas");
					var context3 = canvas3.getContext("2d");
					var imgData3 = context3.getImageData(0, 0, 800, 600);
					context3.putImageData(computeChroma(imgData3, initialIconCanvasImgData, thresh), 0, 0);

				}
			}

			function computeChroma(imgData, initialData, thresh){
				if(thresh>=0){
					for(var x=0; x<imgData.data.length; x=x+4){
						if( ((initialData.data[x]+initialData.data[x+1]+initialData.data[x+2])/3) < thresh){
							imgData.data[x]=0;
							imgData.data[x+1]=0;
							imgData.data[x+2]=0;
							imgData.data[x+3]=255;
						}else{
							imgData.data[x]=initialData.data[x];
							imgData.data[x+1]=initialData.data[x+1];
							imgData.data[x+2]=initialData.data[x+2];
							imgData.data[x+3]=initialData.data[x+3];
						}
					}
				}else{
					for(var x=0; x<imgData.data.length; x=x+4){
						if( ((initialData.data[x]+initialData.data[x+1]+initialData.data[x+2])/3) > (255-Math.abs(thresh)) ){
							imgData.data[x]=0;
							imgData.data[x+1]=0;
							imgData.data[x+2]=0;
							imgData.data[x+3]=255;
						}else{
							imgData.data[x]=initialData.data[x];
							imgData.data[x+1]=initialData.data[x+1];
							imgData.data[x+2]=initialData.data[x+2];
							imgData.data[x+3]=initialData.data[x+3];
						}
					}
				}
				return imgData;
			}

			function requestFullScreen() {
				// Supports most browsers and their versions.
				var element = document.body; // Make the body go full screen.
				var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			
				if (requestMethod) { // Native full screen.
					requestMethod.call(element);
				} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
					var wscript = new ActiveXObject("WScript.Shell");
					if (wscript !== null) {
						wscript.SendKeys("{F11}");
					}
				}
			}
		
		</script>
	</body>
</html>

