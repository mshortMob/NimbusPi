<html>
    <head>
      <title>FlowMapper</title>
      <style>
        body{
          margin: 0px;
          background-color: grey;
          padding-bottom:73px;
          padding-top:0px;
        }
        label{
            display:block;
            position: absolute;
            width: 20%;
            padding-left:2%;
            border: 2px solid black;
            color:black;
            background-color:rgb(100, 100, 100);
            border-radius: 23px
        }
        #saveButton,input{
            display:block;
            position: absolute;
            height:100%;
            top:0%;
            width:74%;
            left:25%;
            border: 2px solid black;
            border-radius: 2px
        }
        #saveButton{
            background-color:rgb(60, 60, 60);
            height:175%;
            color: black;
            font-size:large;
            border: 3px solid black;
        }
        input{
            background-color: white;
            padding-left: 10px;
            border: 2px solid black;
        }
        .row{
            display: block;
            position:relative;
            /* background-color: blue; */
            width: 96%;
            height: 43px;
            line-height: 40px;
            margin-top:26px;
            left:2%;
            padding:0px;
            /* border: 1px solid black; */
        }
        body{ 
          padding-top: 0px;
        }
        .header {
            width:100%;
            top:0px;
            display: grid;
            grid-template-columns: auto auto auto auto auto auto auto auto auto auto auto;
            background-color: black;
            padding: 0px;
            margin-bottom:33px;
            margin-top:0px;
            height:60px;
            z-index:10;
        
        }
        .header-item {
            color:white;
            background-color: black;
            padding: 20px;
            font-size: 19px;
            font-weight:bold;
            text-align: center;
            z-index:10;
            border-bottom:2px solid grey;
            /* border-top:2px solid grey; */
         }
         @media only screen and (max-width:1000px){
            label{
                font-size: x-small;
            }
            .mobile{
                color: white;
            }
            .desktop{
                color: black;
            }
        }
        #dataPage {
            width:90%;
            margin-left: 5%;
            background-color: grey;
            display:grid;
            grid-template-columns: 20% 80%;
        }
        #dataPageGaugeTable {
            display: grid;
            grid-template-rows:25% 25% 25% 25%;
            width: 100%;
            height:350px;
        }
        .dataPageGaugeTable-item{
            border: 3px solid black;
            display: grid;
            height:100%;
            width: 100%;
            margin-bottom:0px;
        }
        #dataPageLabelContainer {
            display: grid;
            grid-template-rows:25% 25% 25% 25%;
            width: 100%;
            height:350px;
        }
        .dataPageGaugeTable-label{
            border: 3px solid black;
            border-bottom: 0px solid black;
            display: grid;
            height:100%;
            width: 100%;
            margin-bottom:0px;
            text-align: center;
            font-size: medium;
        }
        #dataPageLabel_4{
            border-bottom: 3px solid black;
        }
        #testButton {
            display:none;
            position: relative;
            height:80px;
            top:30px;
            width:90%;
            left:5%;
            border: 3px solid black;
            border-radius: 2px;
            background-color:rgb(60, 60, 60);
            color:black;
            font-size:large;
        }
        #presetsPage {
            width:90%;
            margin-left: 5%;
            display: none;
            /* height: 800px; */
            background-color: grey;
            padding: 0px 10px 3px 10px;
        }
        #selectedPresetContainer {
            display:grid;
            grid-template-columns: auto auto auto auto auto auto;
            height:40px;
            width:101%;
            margin-top: 0%;
            padding:0%;
            margin-bottom: 3%;
        }
        .selectedPresetContainerButton {
            background-color: #555555;
            width:100%;
            border: 3px solid black;
            border-right:0px;
           
        }
        #selectedPresetButton5 {
            border-right: 3px solid black;
        }
        .pixel {
            background-color: grey;
            width: 100%;
            height: 100%;
            border: 3px solid black;
        }
        #labelsDiv {
            /* background-color: black; */
            display: grid;
            width:100%;
            height: 20%;
            grid-template-columns: 12.5% 12.5% 12.5% 12.5% 12.5% 12.5% 12.5% 12.5%;
        }
        #slidersDiv {
            /* background-color: black; */
            display: grid;
            width:100%;
            height: 80%;
            grid-template-columns: auto auto auto auto auto auto auto auto;
        }
        .sliderLabel {
            background-color: #222222;
            width: 100%;
            border: 3px solid black;
            border-bottom: 0px;
            color: #aaaaaa;
            font-size: xx-small;
            text-align: center;
        }
        .slider {
            background-color: grey;
            width: 100%;
            height: 100%;
            border: 3px solid black;
        }
        #cpCanvas{
            background-color: black;
            width: 100%;
            height: 40px;
        }
        #slidersContainer{
            /* border: 3px solid black; */
            /* background-color: black; */
            height:300px;
            padding:0%;
            display:grid;
            grid-template-columns: 100%;
        }
        #pixelMapContainer {
            background-color: black;
            width:100%;
            display:grid;
            grid-template-columns:auto auto auto auto auto auto auto auto;
            margin-bottom:3.5%;

        }
        #colorPickerContainer{
            border: 3px solid black;
            background-color: black;
            height:40px;
            width:100%;
            display:grid;
            grid-template-columns:100%;
        }
      </style>
    </head>
    <body>
        <div class="header">
            <div class="header-item">NimbusKit</div>
            <div class="header-item"></div>
            <div class="header-item"></div>  
            <div class="header-item"></div>
            <div class="header-item"></div>
            <div class="header-item"></div>
            <div class="header-item"></div>
            <div class="header-item" onclick="goToPage('presets');">Presets</div>
            <div class="header-item" onclick="goToPage('settings');">Settings</div>
            <div class="header-item" onclick="goToPage('data');">Data</div>
            <div class="header-item"></div>
        </div>
        <div id="dataPage">
            <div id="dataPageLabelContainer"></div>
            <div id="dataPageGaugeTable"></div>
            <button id="testButton" onclick="socket.send('Socket_ABC123');">Test</button>
        </div>
        <div id="presetsPage">
            <div id="selectedPresetContainer">
                <button class="selectedPresetContainerButton">Selected Preset:</button>
                <button id="selectedPresetButton1" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML))">1</button>
                <button id="selectedPresetButton2" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML))">2</button>
                <button id="selectedPresetButton3" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML))">3</button>
                <button id="selectedPresetButton4" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML))">4</button>
                <button id="selectedPresetButton5" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML))">5</button>
            </div>
            <div id="slidersContainer"></div>
            <div id="pixelMapContainer" oncontextmenu="return false;"></div>
            <div id="colorPickerContainer"></div>
        </div>
        <script>

            var fields=[
                {
                    "name":"ssid",
                    "text":"SSID:",
                    "initVal":"---"
                },
                {
                    "name":"password",
                    "text":"Password:",
                    "initVal":"---"
                },
                {
                    "name":"universe",
                    "text":"Universe:",
                    "initVal":"---"
                },
                {
                    "name":"startChan",
                    "text":"Start Channel:",
                    "initVal":"---"
                },
                {
                    "name":"fixtureMode",
                    "text":"Fixture Mode:",
                    "initVal":"---"
                },
                {
                    "name":"num_base_leds",
                    "text":"Number of Pixels:",
                    "initVal":"---"
                },
                {
                    "name":"pixel_start_offset",
                    "text":"Pixel Offset:",
                    "initVal":"---"
                }
            ]
            var ledPresets=[
                {
                    "name":"preset1",
                    "text":"SSID:",
                    "initVal":"---"
                },
                {
                    "name":"preset2",
                    "text":"Password:",
                    "initVal":"---"
                },
                {
                    "name":"preset3",
                    "text":"Universe:",
                    "initVal":"---"
                },
                {
                    "name":"preset4",
                    "text":"Start Channel:",
                    "initVal":"---"
                }
            ]
            ledPresetsPayload=[
                [242,50,200,4,4,3,0,100],
                [50,150,130,16,30,4,0,5],
                [200,2,220,12,1,5,0,55],
                [88,88,88,200,50,6,0,55]
            ];
            dataHistoryBufferLength=60;
            dataHistoryBuffer=[]
            for(var x=0;x<4;x++){
                var tempList=[]
                for(var y=0; y<dataHistoryBufferLength;y++){
                    tempList.push(.5);
                }
                dataHistoryBuffer.push(tempList);
            }
            numRows=8;
            numCols=8;
            pixelMap=[];
            for(var x=0;x<numRows;x++){
                var tempList=[]
                for(var y=0; y<numCols;y++){
                    tempList.push(0);
                }
                pixelMap.push(tempList);
            }
            colorMap = [
                [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0],
                [255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,0]
            ];
            selectedColor=1;
            selectedPreset=1;
            mouseButtonState=0;
            needToUpdatePixelMap=false;
            presetValueDebounceTime=0;
            socketConnectivityCheck=new Date().getTime();
            updatePixelMapInterv=setInterval(function(){
                if(needToUpdatePixelMap){
                    needToUpdatePixelMap=false;
                    makeUpdatPixelMapPostCall();
                }
            },1000);

            window.onload = function(){
                function logButtons(event){
                    // console.log(event.buttons);
                    mouseButtonState=event.buttons;
                }
                document.addEventListener("mouseup", logButtons);
                document.addEventListener("mousedown", logButtons);
                initElements();
                createSliderElements();
                createPixelMapUI();
                initWebSocket();
                setInterval(function(){
                var now=new Date().getTime();
                    if( (now-socketConnectivityCheck) > 5000){
                        initWebSocket();
                        socketConnectivityCheck=now;
                    }
                },5000);
            }

            function initElements(){

                for (var x in fields){
                    var row = document.createElement('div');
                    row.id=fields[x].name+'_row';
                    row.className='row';
                    var label = document.createElement('label');
                    row.appendChild(label);
                    label.for=fields[x].name;
                    label.innerHTML=fields[x].text;
                    var input = document.createElement('input');
                    row.appendChild(input);
                    input.type='text';
                    input.id=fields[x].name;
                    input.value=fields[x].initVal;
                    document.body.appendChild(row);
                }

                createSettingsButton();
                createDataPageGauges();
                function createSettingsButton(){
                    var row = document.createElement('div');
                    row.id='saveButton_row'
                    row.className='row';
                    var button = document.createElement('button');
                    button.innerHTML='Save'
                    row.appendChild(button);
                    button.type='text';
                    button.id='saveButton';
                    button.onclick=function(){
                        makeUpdateSettingsPostCall();
                        console.log('clicked')
                        // socket.send('clicked')
                    }
                    document.body.appendChild(row);
                }

                goToPage('data');
                makeGetSettingsCall();

            }

            function handleSelectedPresetButton(presetNum){
                console.log('handleSelectedPresetButton');
                selectedPreset=presetNum;
                for(var x=1;x<6;x++){
                    if(x!=presetNum){
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#555555';
                    }else{
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#888888';
                    }
                }
                if(selectedPreset!=5){
                    for(var y=0; y<8; y++){
                        document.getElementById('slider'+parseInt(y+1)).setValue(ledPresetsPayload[selectedPreset-1][y]);
                    }
                    makeUpdateLedPresetsPostCall();
                    document.getElementById("colorPickerContainer").style.display='none';
                    document.getElementById("pixelMapContainer").style.display='none';
                    document.getElementById("slidersContainer").style.display='block';
                    for(var x=1; x<9; x++){
                        document.getElementById("sliderLabel"+x).style.lineHeight=parseInt(document.getElementById("sliderLabel"+x).offsetHeight*.92)+'px';
                    }
                }else if(selectedPreset==5){
                    makeUpdateLedPresetsPostCall();
                    document.getElementById("colorPickerContainer").style.display='grid';
                    document.getElementById("pixelMapContainer").style.display='grid';
                    document.getElementById("slidersContainer").style.display='none';
                }
                presetValueDebounceTime=new Date().getTime();
            }

            function updateSelectedPresetButton(){
                console.log('updateSelectedPresetButton');
                for(var x=1;x<6;x++){
                    if(x!=selectedPreset){
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#555555';
                    }else{
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#888888';
                    }
                }
                if(selectedPreset!=5){
                    for(var y=0; y<8; y++){
                        document.getElementById('slider'+parseInt(y+1)).setValue(ledPresetsPayload[selectedPreset-1][y]);
                    }
                    document.getElementById("colorPickerContainer").style.display='none';
                    document.getElementById("pixelMapContainer").style.display='none';
                    document.getElementById("slidersContainer").style.display='block';
                    for(var x=1; x<9; x++){
                        document.getElementById("sliderLabel"+x).style.lineHeight=parseInt(document.getElementById("sliderLabel"+x).offsetHeight*.92)+'px';
                    }
                }else if(selectedPreset==5){
                    document.getElementById("colorPickerContainer").style.display='grid';
                    document.getElementById("pixelMapContainer").style.display='grid';
                    document.getElementById("slidersContainer").style.display='none';
                }
            }

            function makeUpdateSettingsPostCall(){
                var payload={};
                for (var x in fields){
                    payload[fields[x].name]=document.getElementById(fields[x].name).value;
                }
                presetValueDebounceTime=new Date().getTime();
                var urlString='http://'+location.host + '/updateSettings'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200){
                        console.log(this.responseText);
                    }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }

            function makeUpdateLedPresetsPostCall(){
                var payload={"ledPresets":ledPresetsPayload, "selectedPreset":parseInt(selectedPreset-1)};
                var urlString='http://'+location.host + '/updateLedPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    console.log(this.responseText);
                }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }

            function makeGetSettingsCall(){
                var urlString='http://'+location.host + '/getSettings'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    var getResponse=JSON.parse(this.response);
                    console.log(JSON.parse(this.response));
                    for (var x in fields){
                        document.getElementById(fields[x].name).value=getResponse[fields[x].name];
                    }
                    makeGetLedPresetsCall();
                }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeGetPixelMapPresetsCall(){
                var urlString='http://'+location.host + '/getPixelMapPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    var getResponse=JSON.parse(this.response);
                    console.log(JSON.parse(this.response));
                    for(var x=0;x<numRows;x++){
                        for(var y=0; y<numCols;y++){
                            pixelMap[x][y]=getResponse["pixelMap"][x][y];
                        }
                    }
                    refreshPixelMapUI();
                }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeUpdatPixelMapPostCall(){
                var payload={"pixelMap":pixelMap};
                var urlString='http://'+location.host + '/updatePixelMap'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    console.log(this.responseText);
                }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }
            
            function makeGetLedPresetsCall(){
                var urlString='http://'+location.host + '/getLedPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    var getResponse=JSON.parse(this.response);
                    console.log(JSON.parse(this.response));
                    for(var x=0;x<4;x++){
                        for(var y=0; y<8; y++){
                            ledPresetsPayload[x][y]=getResponse["ledPresets"][x][y];
                            document.getElementById('slider'+parseInt(y+1)).setValue(ledPresetsPayload[x][y]);
                        }
                    }
                    handleSelectedPresetButton(parseInt(getResponse["selectedPreset"]+1));
                    makeGetPixelMapPresetsCall();
                }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeResetCall(){
                var urlString='http://'+location.host + '/reset'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    console.log(this.response);
                }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function initWebSocket(){
                socket = new WebSocket("ws:/" + "/" + location.host + ":81");
                socket.onopen = function(e) {  console.log("[socket] socket.onopen "); };
                socket.onerror = function(e) {
                    console.log("[socket] socket.onerror ");
                    console.log(e);
                    setTimeout(function(){
                        console.log("retrying websocket connection initialization")
                        initWebSocket();
                    },1000);
                };
                socket.onclose = function(e) {
                    console.log("[socket] socket.onerror ");
                    console.log(e);
                    setTimeout(function(){
                        console.log("retrying websocket connection initialization")
                        initWebSocket();
                    },1000);
                };
                socket.onmessage = function(e) {  
                    console.log('Received data from websocket: '+e.data);
                    socketConnectivityCheck=new Date().getTime();
                    var incomingData=e.data.split(',');
                    var incomingPreset=parseInt(incomingData[incomingData.length-1])%5;
                    rotateDataHistoryBuffer([parseFloat(incomingData[0]),parseFloat(incomingData[1]),parseFloat(incomingData[2]),parseFloat(parseInt(incomingData[3])/5)+.05 ]);
                    if( (new Date().getTime()-presetValueDebounceTime) > 1000){
                        if(selectedPreset!=(incomingPreset+1)){
                            selectedPreset=(incomingPreset+1);
                            updateSelectedPresetButton();
                            console.log('socket change');
                        }
                    }
                    return true;
                };
            }

            function goToPage(pageName){
                if(pageName=="settings"){
                    for (var x in fields){
                        document.getElementById(fields[x].name+'_row').style.display='block';
                    }
                    document.getElementById('saveButton_row').style.display='block';
                    document.getElementById('dataPage').style.display='none';
                    document.getElementById('presetsPage').style.display='none';
                }
                if(pageName=="data"){
                    for (var x in fields){
                        document.getElementById(fields[x].name+'_row').style.display='none';
                    }
                    document.getElementById('saveButton_row').style.display='none';
                    document.getElementById('dataPage').style.display='grid';
                    document.getElementById('presetsPage').style.display='none';
                    for(var x=1; x<5; x++){
                        document.getElementById("dataPageLabel_"+x).style.lineHeight=parseInt(document.getElementById("dataPageLabel_"+x).offsetHeight*.92)+'px';
                    }
                }
                if(pageName=="presets"){
                    for (var x in fields){
                        document.getElementById(fields[x].name+'_row').style.display='none';
                    }
                    document.getElementById('saveButton_row').style.display='none';
                    document.getElementById('dataPage').style.display='none';
                    document.getElementById('presetsPage').style.display='block';
                    try{
                        if(document.getElementById("slidersContainer").style.display!='none'){
                            for(var x=1; x<9; x++){
                                document.getElementById("sliderLabel"+x).style.lineHeight=parseInt(document.getElementById("sliderLabel"+x).offsetHeight*.92)+'px';
                            }
                        }
                    }
                    catch(err){}
                }
            }

            function createColorPicker(){ 
                var cpCanvas=document.createElement('canvas');
                cpCanvas.className="cpCanvas"
                cpCanvas.id="cpCanvas"
                cpCanvas.isSelected=false;
                cpCanvas.initValue=function(){
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    // ctx.fillStyle = 'rgba(50,50,50,.75)';
                    var gradient = ctx.createLinearGradient(0,0,this.width,0);
                    gradient.addColorStop(0, "black");
                    gradient.addColorStop(.1, "blue");
                    gradient.addColorStop(0.33, "green");
                    gradient.addColorStop(.66, "red");
                    gradient.addColorStop(1, "blue");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, this.width, this.height );
                }
                cpCanvas.updateValue=function(event){
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    // ctx.fillStyle = 'rgba(50,50,50,.75)';
                    var gradient = ctx.createLinearGradient(0,0,this.width,0);
                    gradient.addColorStop(0, "black");
                    gradient.addColorStop(.1, "blue");
                    gradient.addColorStop(0.33, "green");
                    gradient.addColorStop(.66, "red");
                    gradient.addColorStop(1, "blue");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, this.width, this.height );
                    //
                    ctx.fillStyle = "rgba(5,5,5,.8)";
                    var tabWidth=8;
                    var tabCenter=(event.offsetX/this.offsetWidth*this.width);
                    ctx.fillRect(tabCenter-tabWidth/2, 0, tabWidth, this.height );  
                    selectedColor=colorMap[0].length-1-parseInt(event.offsetX/this.offsetWidth*colorMap[0].length);
                    console.log(selectedColor)
                }
                cpCanvas.onmouseup=function(event){
                    this.isSelected=false;
                }
                cpCanvas.onmouseleave=function(event){
                    this.isSelected=false;
                }
                cpCanvas.onmousedown=function(event){
                    this.isSelected=true;
                    this.updateValue(event);
                }
                cpCanvas.onmousemove=function(event){
                    if(this.isSelected){
                        var ctx = this.getContext("2d");
                        this.updateValue(event);
                    }
                }
                cpCanvas.setValue=function(value){
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    var gradient = ctx.createLinearGradient(0,0,this.width,0);
                    gradient.addColorStop(0, "blue");
                    gradient.addColorStop(0.33, "green");
                    gradient.addColorStop(.66, "red");
                    gradient.addColorStop(1, "blue");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, this.width, this.height );
                    //
                    ctx.fillStyle = "rgba(5,5,5,.8)";
                    var tabWidth=8;
                    var tabCenter=(value/(colorMap[0].length-1)*this.width);
                    ctx.fillRect(tabCenter-tabWidth/2, 0, tabWidth, this.height );  
                }
                cpCanvas.ontouchstart=function(event){
                    this.isSelected=true;
                }
                cpCanvas.ontouchend=function(event){
                    this.isSelected=false;
                }
                cpCanvas.ontouchcancel=function(event){
                    this.isSelected=false;
                }
                cpCanvas.ontouchmove=function(event){
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    // ctx.fillStyle = 'rgba(50,50,50,.75)';
                    var gradient = ctx.createLinearGradient(0,0,this.width,0);
                    gradient.addColorStop(0, "black");
                    gradient.addColorStop(.1, "blue");
                    gradient.addColorStop(0.33, "green");
                    gradient.addColorStop(.66, "red");
                    gradient.addColorStop(1, "blue");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, this.width, this.height );
                    //
                    ctx.fillStyle = "rgba(5,5,5,.8)";
                    eventOffsetX=parseInt(event.touches[0].clientX-cpCanvas.offsetLeft);
                    if(eventOffsetX<0){
                        eventOffsetX=0;
                    }
                    if(eventOffsetX>=this.offsetWidth){
                        eventOffsetX=this.offsetWidth;
                    }                    
                    var tabWidth=8;
                    var tabCenter=(eventOffsetX/this.offsetWidth*this.width);
                    ctx.fillRect(tabCenter-tabWidth/2, 0, tabWidth, this.height );
                    selectedColor=colorMap[0].length-1-parseInt(eventOffsetX/this.offsetWidth*colorMap[0].length);
                    console.log(selectedColor)
                }
                cpCanvas.initValue();
                cpCanvas.setValue(selectedColor);
                document.getElementById("colorPickerContainer").appendChild(cpCanvas);
            }

            function refreshPixelMapUI(){
                for(var x=0;x<numRows;x++){
                    for(var y=0; y<numCols;y++){
                        document.getElementById("pixel_"+x+"_"+y).setValue(pixelMap[x][y]);
                    }
                }
            }
            
            function createPixelMapUI(){
                for(var x=0;x<(numRows);x++){
                    for(var y=0;y<(numCols);y++){
                        var canvas=document.createElement('canvas');
                        canvas.className="pixel"
                        canvas.id="pixel_"+x+"_"+y
                        canvas.x=x;
                        canvas.y=y;
                        canvas.value=0;
                        canvas.num=x;
                        canvas.currentChannel=x-1;
                        canvas.updateValue=function(event,action){
                            needToUpdatePixelMap=true;
                            var ctx = this.getContext("2d");
                            ctx.clearRect(0, 0, this.width, this.height);
                            if(action=="add"){
                                ctx.fillStyle = "rgb("+colorMap[0][selectedColor]+","+colorMap[1][selectedColor]+","+colorMap[2][selectedColor]+")";
                                this.value=selectedColor;
                            }
                            if(action=="remove"){
                                ctx.fillStyle = "rgb("+colorMap[0][colorMap[0].length-1]+","+colorMap[1][colorMap[0].length-1]+","+colorMap[2][colorMap[0].length-1]+")";
                                this.value=colorMap[0].length-1;
                            }
                            ctx.fillRect(0, 0, this.width,this.height );
                            for(var x=0;x<numRows;x++){
                                for(var y=0; y<numCols;y++){
                                    pixelMap[x][y]=document.getElementById("pixel_"+x+"_"+y).value;
                                }
                            }
                        }
                        canvas.onmousedown=function(event){
                            if(mouseButtonState==1){
                                this.updateValue(event,"add");
                            }
                            if(mouseButtonState==2){
                                this.updateValue(event,"remove");
                            }
                        }
                        canvas.onmousemove=function(event){
                            if(mouseButtonState==1){
                                this.updateValue(event,"add");
                            }
                            if(mouseButtonState==2){
                                this.updateValue(event,"remove");
                            }
                        }
                        canvas.setValue=function(value){
                            this.value=value;
                            var ctx = this.getContext("2d");
                            ctx.clearRect(0, 0, this.width, this.height);
                            ctx.fillStyle = "rgb("+colorMap[0][this.value]+","+colorMap[1][this.value]+","+colorMap[2][this.value]+")";
                            ctx.fillRect(0, 0, this.width, this.height ); 
                        }
                        canvas.ontouchstart=function(event){
                            needToUpdatePixelMap=true;
                            var ctx = this.getContext("2d");
                            ctx.clearRect(0, 0, this.width, this.height);
                            ctx.fillStyle = "rgb("+colorMap[0][selectedColor]+","+colorMap[1][selectedColor]+","+colorMap[2][selectedColor]+")";
                            this.value=selectedColor;
                            ctx.fillRect(0, 0, this.width,this.height );
                            for(var x=0;x<numRows;x++){
                                for(var y=0; y<numCols;y++){
                                    pixelMap[x][y]=document.getElementById("pixel_"+x+"_"+y).value;
                                }
                            }
                        }
                        canvas.ontouchmove=function(event){
                            needToUpdatePixelMap=true;
                            try{
                                document.elementFromPoint(event.touches[0].clientX, event.touches[0].clientY).value=selectedColor;
                                document.elementFromPoint(event.touches[0].clientX, event.touches[0].clientY).updateValue(event,"add");
                            }
                            catch{}
                        }
                        document.getElementById("pixelMapContainer").appendChild(canvas);           
                    }    
                }
                createColorPicker();
                refreshPixelMapUI();
            }

            function createSliderElements(){
                var labelsDiv=document.createElement('div');
                var slidersDiv=document.createElement('div');
                labelsDiv.id="labelsDiv";
                slidersDiv.id="slidersDiv";
                document.getElementById("slidersContainer").appendChild(labelsDiv);
                document.getElementById("slidersContainer").appendChild(slidersDiv);
                for(var x=1; x<9; x++){
                    var canvas=document.createElement('canvas');
                    canvas.className="slider"
                    canvas.id="slider"+x
                    canvas.num=x;
                    canvas.currentChannel=x-1;
                    canvas.isSelected=false;
                    canvas.updateValue=function(event){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(0, 0, this.width, event.offsetY/this.offsetHeight*this.height ); 
                        var value=255-parseInt(event.offsetY/this.offsetHeight*255);
                        if(value<12){
                            value=0;
                        }
                        for(var y=1;y<9;y++){
                            if(this.num==y){
                                ledPresetsPayload[selectedPreset-1][y-1]=value;
                            }
                        }
                        console.log('slider updateValue');
                        makeUpdateLedPresetsPostCall();
                    }
                    canvas.onmouseup=function(event){
                        this.isSelected=false;
                    }
                    canvas.onmouseleave=function(event){
                        this.isSelected=false;
                    }
                    canvas.onmousedown=function(event){
                        this.isSelected=true;
                        this.updateValue(event);
                    }
                    canvas.onmousemove=function(event){
                        if(this.isSelected){
                            var ctx = this.getContext("2d");
                            this.updateValue(event);
                        }
                    }
                    canvas.setValue=function(value){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(0, 0, this.width, parseInt((255-value)/255*this.height) ); 
                    }
                    canvas.ontouchstart=function(event){
                        this.isSelected=true;
                    }
                    canvas.ontouchend=function(event){
                        this.isSelected=false;
                    }
                    canvas.ontouchcancel=function(event){
                        this.isSelected=false;
                    }
                    canvas.ontouchmove=function(event){
                        if(this.isSelected){
                            var ctx = this.getContext("2d");
                            eventOffsetY=parseInt(event.touches[0].clientY-this.offsetTop);
                            if(eventOffsetY<0){
                                eventOffsetY=0;
                            }
                            if(eventOffsetY>=this.offsetHeight){
                                eventOffsetX=this.offsetHeight;
                            }  
                            event.offsetY=eventOffsetY;  
                            this.updateValue(event);
                        }
                    }
                    
                    slidersDiv.appendChild(canvas);

                    var sliderLabelValues=[
                        'Color',
                        'ColorSpread',
                        'CycleTime',
                        'TrailLength',
                        'TrailSpread',
                        'Direction',
                        'Strobe',
                        'Brightness'
                    ]
                    var label=document.createElement('span');
                    label.className="sliderLabel";
                    label.id="sliderLabel"+x;
                    labelsDiv.appendChild(label)
                    label.innerHTML=sliderLabelValues[canvas.num-1];
                }
                handleSelectedPresetButton(5);
            }        

            function rotateDataHistoryBuffer(incomingValue){
                for(var x=0; x<dataHistoryBufferLength; x++){
                    if(x<(dataHistoryBufferLength-1)){
                        dataHistoryBuffer[0][x]=dataHistoryBuffer[0][x+1];
                        dataHistoryBuffer[1][x]=dataHistoryBuffer[1][x+1];
                        dataHistoryBuffer[2][x]=dataHistoryBuffer[2][x+1];
                        dataHistoryBuffer[3][x]=dataHistoryBuffer[3][x+1];
                    }else{
                        dataHistoryBuffer[0][x]=incomingValue[0];
                        dataHistoryBuffer[1][x]=incomingValue[1];
                        dataHistoryBuffer[2][x]=incomingValue[2];
                        dataHistoryBuffer[3][x]=incomingValue[3];
                    }
                }
                for(var x=1; x<5; x++){
                    document.getElementById("dataPageGauge_"+x).updateValue();
                }
            }

            function createDataPageGauges(){
                for(var x=1; x<5; x++){
                    var label=document.createElement('div');
                    label.className="dataPageGaugeTable-label"
                    label.id="dataPageLabel_"+x
                    label.num=x;
                    label.innerHTML=label.num;
                    var sliderLabelValues=[
                        'X:',
                        'Y:',
                        'Z:',
                        'Button:'
                    ]
                    label.innerHTML=sliderLabelValues[label.num-1];
                    document.getElementById("dataPageLabelContainer").appendChild(label)

                    var canvas=document.createElement('canvas');
                    canvas.className="dataPageGaugeTable-item"
                    canvas.id="dataPageGauge_"+x
                    canvas.num=x;
                    canvas.width=800;
                    canvas.height=200;
                    canvas.updateValue=function(){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#555555";
                        ctx.fillRect(0, 0, this.width, this.height );

                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#bbbbbb';
                        ctx.beginPath();
                        for(var x=0; x<dataHistoryBufferLength; x++){
                            if(x==0){
                                ctx.moveTo(x*parseInt(this.width/dataHistoryBufferLength), parseInt(dataHistoryBuffer[this.num-1][x]*this.height));
                            }else{
                                ctx.lineTo(x*parseInt(this.width/dataHistoryBufferLength), parseInt(dataHistoryBuffer[this.num-1][x]*this.height));
                            }
                        }
                        ctx.lineTo(this.width, parseInt(dataHistoryBuffer[this.num-1][dataHistoryBufferLength-1]*this.height));
                        ctx.stroke();
                    }
                    canvas.setValue=function(){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#555555";
                        ctx.fillRect(0, 0, this.width, this.height );

                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#bbbbbb';
                        ctx.beginPath();
                        for(var x=0; x<dataHistoryBufferLength; x++){
                            if(x==0){
                                ctx.moveTo(x*parseInt(this.width/dataHistoryBufferLength), parseInt(dataHistoryBuffer[this.num-1][x]*this.height));
                            }else{
                                ctx.lineTo(x*parseInt(this.width/dataHistoryBufferLength), parseInt(dataHistoryBuffer[this.num-1][x]*this.height));
                            }
                        }
                        ctx.lineTo(this.width, parseInt(dataHistoryBuffer[this.num-1][dataHistoryBufferLength-1]*this.height));
                        ctx.stroke();
                    }
                    canvas.setValue();
                    document.getElementById("dataPageGaugeTable").appendChild(canvas)
                }
            }

        </script>
    </body>
</html>
