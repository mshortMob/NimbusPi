<html>
    <head>
      <title>FlowMapper</title>
      <style>
        /* global */
        #background {
            position:absolute;
            display:block;
            height:100%;
            width:100%;
            z-index: 10000;
            background-color: grey;
            overflow: auto;
        }
        body{
          margin: 0px;
          height:100%;
          width:100%;
          /* display:grid; */
        }
        #header {
            width:100%;
            height:70px;
            display: grid;
            grid-template-columns: 2% auto auto auto auto auto auto auto auto auto auto auto 5%;
            background-color: #020240;
            border-bottom:3px solid darkgrey;
            /* border-top:2px solid darkgrey; */
            /* border-top:1px solid #eeeeee; */
        }
        #mainLogo{
            font-size: medium;
        }
        .header-item {
            color:#eeeeee;
            background-color: #020240;
            font-size: small;
            font-weight:bold;
            text-align: center;
            border: 0px solid #020240;
            /* border-top:3px solid darkgrey; */
            height:100%;
        }
        #topSpacer{
            width:100%;
            height:24px;    
        }
        #bottomSpacer{
            height:20px;
        }
        .page{
            width:90%;
            margin-left:5%;
            height:30px;
            display:none;
        }
        /* dataPage */
        #dataPage{
            grid-template-columns: 20% 80%;
        }
        #dataPageLabelsContainer{
            display:grid;
            grid-template-rows: 25% 25% 25% 25%;
            margin-right:3px;
        }
        #dataPageGraphsContainer{
            display:grid;
            grid-template-rows: 25% 25% 25% 25%;
        }
        .dataPageGraphItem{
            display:grid;
            height: 80%;
            width: 100%;
            border: 3px solid black;
        }
        .dataPageGraphCanvas{
            display:grid;
            width:100%;
            margin:0px;
        }
        .dataPageLabelItem{
            display:grid;
            height: 80%;
            border: 3px solid black;  
            grid-template-rows: 38% 29% 33%;    
            margin-right:-6px;  
            background-color:rgb(100, 100, 100);
        }
        .dataPageLabelSpacer{
            display:grid;
            border: 0px solid black;
            text-align: center;
            height:100%;
            font-weight: bold;
        }
        /* settingsPage */
        #settingPage{
            grid-template-columns: 100%;
        }
        .settingsPageRow{
            display: block;
            position: relative;
            height: 43px;
            margin-bottom:36px;
        }
        .settingsPageLabel {
            border: 2px solid black;
            color:black;
            background-color:rgb(100, 100, 100);
            border-radius: 23px;
            text-align:middle;
            line-height: 43px;
            font-size:small;
            width:30%;
            display: inline;
            font-weight:bold;
        }
        .settingsPageInput, #saveButton{
            background-color: white;
            padding-left: 2%;
            border: 2px solid black;
            width:68%;
            margin-left:2%;
            display: inline;
            height:43px;
        }
        #saveButton{
            background-color:rgb(60, 60, 60);
            /* height:150%; */
            margin-left:32%;
            margin-bottom: 36px;
            color: black;
            font-size:large;
            border: 2px solid black;
        }
        /* presetsPage */
        #presetsPage{
            grid-template-rows: 12% 72% 16%;
        }
        #selectedPresetContainer{
            margin-bottom:20px;
            grid-template-columns: 15% 10% 10% 10% 10% 10% 5% 10% 10% 10%;
            display: grid;
            margin-top:-6px;
        }
        .selectedPresetContainerButton, .selectedPresetContainerLabel {
            background-color: #555555;
            height:100%;
            border: 3px solid black;
            margin-left:-3px;
            font-size: x-small;
        }
        .selectedPresetContainerLabel{
            font-weight: bold;
            background-color: #444444;
        }
        #selectedPresetTypeSpacer{
            border-top:0px;
            border-bottom: 0px;
            background-color: grey;
        }
        #pixelMapContainer{
            background-color: grey;
            z-index: 4000000000;
            margin-bottom:20px;
            display:grid;
            grid-template-columns: auto auto auto auto auto auto auto auto;
        }
        .pixel{
            display:grid;
            border:3px solid black;
            background-color: red;
        }
        #colorPickerContainer{
            border:3px solid black;
            margin:0px;
            padding:0px;
            height:100%;
            grid-template-columns: auto;
        }
        #cpCanvas{
            display:grid;
            width:100%;
            height:100%;
        }
        #synthSlidersContainer{
            background-color: grey;
            height:121%;
            display:none;
            width:100%;
            grid-template-rows: 20% 80%;
            margin-left:-3px;
        }
        #labelsDiv {
            display: grid;
            width:100%;
            grid-template-columns: 12.5% 12.5% 12.5% 12.5% 12.5% 12.5% 12.5% 12.5%;
        }
        #slidersDiv {
            display: grid;
            width:100%;
            grid-template-columns: auto auto auto auto auto auto auto auto;
        }
        .sliderLabel {
            background-color: #222222;
            width: 100%;
            border: 3px solid black;
            border-bottom: 0px;
            color: #aaaaaa;
            font-size: xx-small;
            text-align: center;
        }
        .slider {
            background-color: rgb(70,70,70);
            width: 100%;
            height: 100%;
            border: 3px solid black;
        }
      </style>
    </head>
    <body>
        <div id="background">
            <div id="header">
                <button class="header-item"></button>
                <button class="header-item" id="mainLogo"onclick="requestFullScreen();">NimbusKit</button>
                <button class="header-item"></button>  
                <button class="header-item"></button>
                <button class="header-item"></button>
                <button class="header-item"></button>
                <button class="header-item"></button>
                <button class="header-item"></button>
                <button class="header-item"></button>
                <button class="header-item" onclick="goToPage('presetsPage');">Presets</button>
                <button class="header-item" onclick="goToPage('settingsPage');">Settings</button>
                <button class="header-item" onclick="goToPage('dataPage');">Data</button>
                <button class="header-item"></button>
            </div>
            <div id="topSpacer">
            </div>
            <div id="dataPage" class="page">
                <div id="dataPageLabelsContainer"></div>
                <div id="dataPageGraphsContainer"></div>
            </div>
            <div id="presetsPage" class="page">
                <div id="selectedPresetContainer">
                    <button class="selectedPresetContainerLabel">Number:</button>
                    <button id="selectedPresetButton1" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML),'numberbutton')">1</button>
                    <button id="selectedPresetButton2" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML),'numberbutton')">2</button>
                    <button id="selectedPresetButton3" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML),'numberbutton')">3</button>
                    <button id="selectedPresetButton4" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML),'numberbutton')">4</button>
                    <button id="selectedPresetButton5" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton(parseInt(this.innerHTML),'numberbutton')">5</button>
                    <button id="selectedPresetTypeSpacer" class="selectedPresetContainerButton"></button>
                    <button class="selectedPresetContainerLabel">Type:</button>      
                    <button id="synthTypeButton" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton('synth','typebutton')">Synth</button>
                    <button id="pixelTypeButton" class="selectedPresetContainerButton" onclick="handleSelectedPresetButton('pixel','typebutton')">Pixel</button>
                </div>
                <div id="synthSlidersContainer">
                </div>
                <div id="pixelMapContainer" oncontextmenu="return false;">
                </div>
                <div id="colorPickerContainer">
                </div>
            </div>
            <div id="settingsPage" class="page">
            </div>
            <div id="bottomSpacer">
            </div>
        </div>
        <script>

            globals={
                currentPage: "presetsPage",
                dataHistoryBuffer: [
                    [
                        .5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5
                    ],
                    [
                        .5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5
                    ],
                    [
                        .5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5
                    ],
                    [
                        .5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5,.5
                    ],
                ],
                settingsPageFields:[
                {
                    "name":"ssid",
                    "text":"SSID:",
                    "initVal":"---"
                },
                {
                    "name":"password",
                    "text":"Password:",
                    "initVal":"---"
                },
                {
                    "name":"universe",
                    "text":"Universe:",
                    "initVal":"---"
                },
                {
                    "name":"startChan",
                    "text":"Start Channel:",
                    "initVal":"---"
                },
                {
                    "name":"fixtureMode",
                    "text":"Fixture Mode:",
                    "initVal":"---"
                },
                {
                    "name":"num_base_leds",
                    "text":"Num of Pixels:",
                    "initVal":"---"
                },
                {
                    "name":"pixel_start_offset",
                    "text":"Pixel Offset:",
                    "initVal":"---"
                }
            ],
                numRows: 8,
                numCols: 8,
                pixelMap: [
                    [[0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0]],
                    [[0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0]],
                    [[0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0]],
                    [[0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0]],
                    [[0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0]],
                ],
                colorMap: [
                    [0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0],
                    [255,250,245,240,235,230,225,220,215,210,205,200,195,190,185,180,175,170,165,160,155,150,145,140,135,130,125,120,115,110,105,100,95,90,85,80,75,70,65,60,55,50,45,40,35,30,25,20,15,10,5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,5,10,15,20,25,30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,110,115,120,125,130,135,140,145,150,155,160,165,170,175,180,185,190,195,200,205,210,215,220,225,230,235,240,245,250,255,0]
                ],
                presetTypes: ["pixel","pixel","pixel","synth","synth"],
                synthSliderValues: [
                    [128, 128, 128, 128, 128, 128, 128, 128],
                    [128, 128, 128, 128, 128, 128, 128, 128],
                    [128, 128, 128, 128, 128, 128, 128, 128],
                    [128, 128, 128, 128, 128, 128, 128, 128],
                    [128, 128, 128, 128, 128, 128, 128, 128]
                ],
                selectedColor:1,
                selectedPreset: 1,
                mouseButtonState: 0,
                needToUpdatePixelMap: false,
                needToUpdateLedPresets: false,
                socketConnectivityCheck: new Date().getTime(),
                presetValueDebounceTime: new Date().getTime(),
            }

            window.onload = function(){
                function logButtons(event){
                    globals.mouseButtonState=event.buttons;
                }
                document.addEventListener("mouseup", logButtons);
                document.addEventListener("mousedown", logButtons);
                createDataPage();
                createSettingsPage();
                createPixelMapUI();
                createColorPicker();
                createSynthSliders();
                initOrientationListener();
                goToPage(globals.currentPage);
                makeGetSettingsCall();
                updatePixelMapInterv=setInterval(function(){
                    if(globals.needToUpdatePixelMap){
                        globals.needToUpdatePixelMap=false;
                        makeUpdatPixelMapCall();
                    }
                },1000);
                updateLedPresets=setInterval(function(){
                    if(globals.needToUpdateLedPresets){
                        globals.needToUpdateLedPresets=false;
                        makeUpdateLedPresetsCall();
                    }
                },1000);
                initWebSocket();
                setInterval(function(){
                    var now=new Date().getTime();
                    if( (now-globals.socketConnectivityCheck) > 5000){
                        initWebSocket();
                        gobals.socketConnectivityCheck=now;
                    }
                },5000);
            }

            window.onresize = function() {
                resizePages();
            };

            function syncView(){
                // pixel map grid
                for(var x=0;x<globals.numRows;x++){
                    for(var y=0; y<globals.numCols;y++){
                        document.getElementById("pixel_"+x+"_"+y).setValue(globals.pixelMap[globals.selectedPreset-1][x][y]);
                    }
                }
                // color picker
                document.getElementById("cpCanvas").setValue(globals.colorMap[0].length-globals.selectedColor);
                // selected preset
                for(var x=1;x<6;x++){
                    if(x!=globals.selectedPreset){
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#555555';
                    }else{
                        document.getElementById("selectedPresetButton"+x).style.backgroundColor='#888888';
                    }
                }
                // selected preset type
                if(globals.presetTypes[globals.selectedPreset-1]=="synth"){
                    document.getElementById("synthTypeButton").style.backgroundColor='#888888';
                    document.getElementById("pixelTypeButton").style.backgroundColor='#555555';
                    document.getElementById("synthSlidersContainer").style.display='grid';
                    document.getElementById("pixelMapContainer").style.display='none';
                    document.getElementById("colorPickerContainer").style.display='none';
                }else{
                    if(globals.presetTypes[globals.selectedPreset-1]=="pixel"){
                        document.getElementById("synthTypeButton").style.backgroundColor='#555555';
                        document.getElementById("pixelTypeButton").style.backgroundColor='#888888';
                        document.getElementById("synthSlidersContainer").style.display='none';
                        document.getElementById("pixelMapContainer").style.display='grid';
                        document.getElementById("colorPickerContainer").style.display='block';
                    }
                }
                // synth slider values
                for(var x=1; x<9; x++){
                    document.getElementById("slider"+x).setValue(globals.synthSliderValues[globals.selectedPreset-1][x-1]);
                }
                // resize all
                resizePages();
            }

            function resizePages(){
                // Header vs body size
                const pages = document.getElementsByClassName("page");
                for (let i = 0; i < pages.length; i++) {
                    pages.item(i).style.height=parseInt(window.innerHeight-(document.getElementById("header").offsetHeight + document.getElementById("topSpacer").offsetHeight + document.getElementById("bottomSpacer").offsetHeight))+'px';
                }
                // Data page graph canvases
                for(var x=1; x<5; x++){
                    try{
                        document.getElementById("dataPageGraphCanvas_"+x).refreshCanvas();
                    }
                    catch{}
                }
                // Settings page background extend
                if(globals.currentPage=="settingsPage"){
                    var fieldStaticHeight=parseInt(79*(globals.settingsPageFields.length+1) + 130);
                    var pageHeight=window.innerHeight;
                    if(fieldStaticHeight<pageHeight){
                        document.getElementById("background").style.height='100%';
                    }else{
                        document.getElementById("background").style.height=fieldStaticHeight+'px';
                    }
                }else{
                    document.getElementById("background").style.height='100%';
                }
                // Color picker canvas
                document.getElementById("cpCanvas").setValue(globals.colorMap[0].length-globals.selectedColor)
                // Synth Slider Labels
                for(var x=1; x<9; x++){
                    document.getElementById("sliderLabel"+x).refreshLabel();
                }
                // Synth canvases
                for(var x=1; x<9; x++){
                    document.getElementById("slider"+x).refresh();
                }
                // adjust for screen orientation
                processOrientation((screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation);
            }

            function goToPage(pageName){
                globals.currentPage=pageName;
                const pages = document.getElementsByClassName("page");
                for (let i = 0; i < pages.length; i++) {
                    console.log(pages.item(i).id)
                    if(pages.item(i).id==pageName){
                        if(pageName=="settingsPage"){
                            pages.item(i).style.display='block';
                        }else{
                            pages.item(i).style.display='grid';
                            document.getElementById("background").style.height='100%';
                        }
                    }else{
                        pages.item(i).style.display='none'
                    }
                }            
                syncView();
            }

            function handleSelectedPresetButton(inputValue, buttonType){
                if(buttonType=="typebutton"){
                    globals.presetTypes[globals.selectedPreset-1]=inputValue;
                }else if(buttonType=="numberbutton"){
                    globals.selectedPreset=inputValue;
                }
                makeUpdateLedPresetsCall();
                syncView();                    
            }

			function requestFullScreen() {
				// Supports most browsers and their versions.
				var element = document.getElementById("background"); // Make the body go full screen.
				var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullScreen;
			
				if (requestMethod) { // Native full screen.
					requestMethod.call(element);
				} else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
					var wscript = new ActiveXObject("WScript.Shell");
					if (wscript !== null) {
						wscript.SendKeys("{F11}");
					}
				}
			}

            function createDataPage(){
                for(var x=1; x<5; x++){
                    // Label
                    var label=document.createElement('div');
                    label.className="dataPageLabelItem"
                    label.id="dataPageLabel_"+x
                    label.num=x;
                    var sliderLabelValues=[
                        'X:',
                        'Y:',
                        'Z:',
                        'Button:'
                    ]
                    for(y=1;y<4;y++){
                        var labelSpacer=document.createElement('div');
                        labelSpacer.className="dataPageLabelSpacer"
                        labelSpacer.id="dataPageLabelSpacer_"+x+"_"+y;
                        if(y==2){
                            labelSpacer.innerHTML=sliderLabelValues[label.num-1];
                        }else{
                            labelSpacer.innerHTML=' ';
                        }
                        label.appendChild(labelSpacer);
                    }
                    document.getElementById("dataPageLabelsContainer").appendChild(label);
                    // Graph
                    var canvasContainer=document.createElement('div');
                    canvasContainer.className="dataPageGraphItem"
                    canvasContainer.id="dataPageGraphItem_"+x
                    canvasContainer.num=x;
                    var canvas=document.createElement('canvas');
                    canvas.className="dataPageGraphCanvas"
                    canvas.id="dataPageGraphCanvas_"+x
                    canvas.num=x;
                    canvas.width=parseInt(document.getElementById("dataPage").offsetWidth*.8);   
                    canvas.height=parseInt(document.getElementById("dataPage").offsetHeight/4*.8);             
                    canvas.refreshCanvas=function(){
                        this.width=parseInt(document.getElementById("dataPage").offsetWidth*.8);
                        this.height=parseInt(document.getElementById("dataPage").offsetHeight/4*.8);
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#555555";
                        ctx.fillRect(0, 0, this.width, this.height );

                        ctx.lineWidth = 2;
                        ctx.strokeStyle = '#bbbbbb';
                        ctx.beginPath();
                        for(var x=0; x<globals.dataHistoryBuffer[0].length; x++){
                            if(x==0){
                                ctx.moveTo(x*parseInt(this.width/globals.dataHistoryBuffer[0].length), parseInt(globals.dataHistoryBuffer[this.num-1][x]*this.height));
                            }else{
                                ctx.lineTo(x*parseInt(this.width/globals.dataHistoryBuffer[0].length), parseInt(globals.dataHistoryBuffer[this.num-1][x]*this.height));
                            }
                        }
                        ctx.lineTo(this.width, parseInt(globals.dataHistoryBuffer[this.num-1][globals.dataHistoryBuffer[0].length-1]*this.height));
                        ctx.stroke();
                    }
                    canvas.refreshCanvas();
                    canvasContainer.appendChild(canvas);
                    document.getElementById("dataPageGraphsContainer").appendChild(canvasContainer);
                }
            }

            function createSettingsPage(){
                for (var x in globals.settingsPageFields){
                    var row = document.createElement('div');
                    row.id="settingsPageRow_"+x;
                    row.className='settingsPageRow';
                    var label = document.createElement('button');
                    label.className="settingsPageLabel";
                    // label.for=globals.settingsPageFields[x].name;
                    label.innerHTML=globals.settingsPageFields[x].text;
                    row.appendChild(label);
                    var input = document.createElement('input');
                    input.type='text';
                    input.className="settingsPageInput";
                    input.id=globals.settingsPageFields[x].name;
                    input.value=globals.settingsPageFields[x].initVal;
                    row.appendChild(input);
                    document.getElementById("settingsPage").appendChild(row);
                }
                var row = document.createElement('div');
                row.id='saveButton_row'
                row.className='saveButton';
                var button = document.createElement('button');
                button.innerHTML='Save'
                row.appendChild(button);
                button.type='text';
                button.id='saveButton';
                button.onclick=function(){
                    makeUpdateSettingsCall();
                    console.log('clicked')
                }
                document.getElementById("settingsPage").appendChild(row);
            }

            function rotateDataHistoryBuffer(incomingValue){
                for(var x=0; x<globals.dataHistoryBuffer[0].length; x++){
                    if(x<(globals.dataHistoryBuffer[0].length-1)){
                        globals.dataHistoryBuffer[0][x]=globals.dataHistoryBuffer[0][x+1];
                        globals.dataHistoryBuffer[1][x]=globals.dataHistoryBuffer[1][x+1];
                        globals.dataHistoryBuffer[2][x]=globals.dataHistoryBuffer[2][x+1];
                        globals.dataHistoryBuffer[3][x]=globals.dataHistoryBuffer[3][x+1];
                    }else{
                        globals.dataHistoryBuffer[0][x]=incomingValue[0];
                        globals.dataHistoryBuffer[1][x]=incomingValue[1];
                        globals.dataHistoryBuffer[2][x]=incomingValue[2];
                        globals.dataHistoryBuffer[3][x]=incomingValue[3];
                    }
                }
                for(var x=1; x<5; x++){
                    try{
                        document.getElementById("dataPageGraphCanvas_"+x).refreshCanvas()
                    }
                    catch{}
                }
            }
      
            function createPixelMapUI(){
                for(var x=0;x<(globals.numRows);x++){
                    for(var y=0;y<(globals.numCols);y++){
                        var canvas=document.createElement('div');
                        canvas.className="pixel"
                        canvas.id="pixel_"+x+"_"+y
                        canvas.x=x;
                        canvas.y=y;
                        canvas.value=0;
                        canvas.num=x;
                        canvas.updateValue=function(event,action){
                            if(action=="add"){
                                this.style.backgroundColor = "rgb("+globals.colorMap[0][globals.selectedColor]+","+globals.colorMap[1][globals.selectedColor]+","+globals.colorMap[2][globals.selectedColor]+")";
                                this.value=globals.selectedColor;
                            }
                            if(action=="remove"){
                                this.style.backgroundColor = "rgb("+globals.colorMap[0][globals.colorMap[0].length-1]+","+globals.colorMap[1][globals.colorMap[0].length-1]+","+globals.colorMap[2][globals.colorMap[0].length-1]+")";
                                this.value=globals.colorMap[0].length-1;
                            }
                            for(var x=0;x<globals.numRows;x++){
                                for(var y=0; y<globals.numCols;y++){
                                    globals.pixelMap[globals.selectedPreset-1][x][y]=document.getElementById("pixel_"+x+"_"+y).value;
                                }
                            }
                            globals.needToUpdatePixelMap=true;
                        }
                        canvas.onmousedown=function(event){
                            if(globals.mouseButtonState==1){
                                this.updateValue(event,"add");
                            }
                            if(globals.mouseButtonState==2){
                                this.updateValue(event,"remove");
                            }
                        }
                        canvas.onmousemove=function(event){
                            if(globals.mouseButtonState==1){
                                this.updateValue(event,"add");
                                console.log("add");
                            }
                            if(globals.mouseButtonState==2){
                                this.updateValue(event,"remove");
                            }
                        }
                        canvas.setValue=function(value){
                            this.value=value;
                            this.style.backgroundColor = "rgb("+globals.colorMap[0][this.value]+","+globals.colorMap[1][this.value]+","+globals.colorMap[2][this.value]+")";
                        }
                        canvas.ontouchstart=function(event){
                            console.log(event)
                            globals.needToUpdatePixelMap=true;
                            this.style.backgroundColor = "rgb("+globals.colorMap[0][globals.selectedColor]+","+globals.colorMap[1][globals.selectedColor]+","+globals.colorMap[2][globals.selectedColor]+")";
                            this.value=globals.selectedColor;
                            for(var x=0;x<globals.numRows;x++){
                                for(var y=0; y<globals.numCols;y++){
                                    globals.pixelMap[globals.selectedPreset-1][x][y]=document.getElementById("pixel_"+x+"_"+y).value;
                                }
                            }
                        }
                        canvas.ontouchmove=function(event){
                            globals.needToUpdatePixelMap=true;
                            try{
                                document.elementFromPoint(event.touches[0].clientX, event.touches[0].clientY).value=globals.selectedColor;
                                document.elementFromPoint(event.touches[0].clientX, event.touches[0].clientY).updateValue(event,"add");
                            }
                            catch{}
                        }
                        document.getElementById("pixelMapContainer").appendChild(canvas);           
                    }    
                }
            }

            function createColorPicker(){ 
                var cpCanvas=document.createElement('canvas');
                cpCanvas.className="cpCanvas"
                cpCanvas.id="cpCanvas"
                cpCanvas.isSelected=false;
                cpCanvas.refreshCanvas=function(){
                    this.width=document.getElementById("colorPickerContainer").offsetWidth;
                    this.height=document.getElementById("colorPickerContainer").offsetHeight;
                    var ctx = this.getContext("2d");
                    ctx.clearRect(0, 0, this.width, this.height);
                    var gradient = ctx.createLinearGradient(0,0,this.width,0);
                    gradient.addColorStop(0, "black");
                    gradient.addColorStop(.1, "blue");
                    gradient.addColorStop(0.33, "green");
                    gradient.addColorStop(.66, "red");
                    gradient.addColorStop(1, "blue");
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, this.width, this.height );
                }
                cpCanvas.updateValue=function(event){
                    this.refreshCanvas();
                    var ctx = this.getContext("2d");
                    ctx.fillStyle = "rgba(5,5,5,.8)";
                    var tabWidth=8;
                    if(event.offsetX<0){
                        event.offsetX=0;
                    }
                    if(event.offsetX>this.offsetWidth){
                        event.offsetX=this.offsetWidth;
                    }
                    var tabCenter=(event.offsetX/this.offsetWidth*this.width);
                    ctx.fillRect(tabCenter-tabWidth/2, 0, tabWidth, this.height );  
                    globals.selectedColor=globals.colorMap[0].length-1-parseInt(event.offsetX/this.offsetWidth*globals.colorMap[0].length);
                    if(globals.selectedColor<0){
                        globals.selectedColor=0;
                    }
                    console.log(globals.selectedColor)
                }
                cpCanvas.onmouseup=function(event){
                    this.isSelected=false;
                }
                cpCanvas.onmouseleave=function(event){
                    this.isSelected=false;
                }
                cpCanvas.onmousedown=function(event){
                    this.isSelected=true;
                    this.updateValue(event);
                }
                cpCanvas.onmousemove=function(event){
                    if(this.isSelected){
                        var ctx = this.getContext("2d");
                        this.updateValue(event);
                    }
                }
                cpCanvas.setValue=function(value){
                    this.refreshCanvas();
                    var ctx = this.getContext("2d");
                    ctx.fillStyle = "rgba(5,5,5,.8)";
                    var tabWidth=8;
                    var tabCenter=(value/(globals.colorMap[0].length-1)*this.width);
                    ctx.fillRect(tabCenter-tabWidth/2, 0, tabWidth, this.height );  
                }
                cpCanvas.ontouchstart=function(event){
                    this.isSelected=true;
                    event.offsetX=parseInt(event.touches[0].clientX-cpCanvas.offsetLeft);
                    this.updateValue(event);
                }
                cpCanvas.ontouchend=function(event){
                    this.isSelected=false;
                }
                cpCanvas.ontouchcancel=function(event){
                    this.isSelected=false;
                }
                cpCanvas.ontouchmove=function(event){
                    event.offsetX=parseInt(event.touches[0].clientX-cpCanvas.offsetLeft);
                    this.updateValue(event);
                }
                cpCanvas.refreshCanvas();
                cpCanvas.setValue(globals.selectedColor);
                document.getElementById("colorPickerContainer").appendChild(cpCanvas);
            }

            function createSynthSliders(){
                var labelsDiv=document.createElement('div');
                var slidersDiv=document.createElement('div');
                labelsDiv.id="labelsDiv";
                slidersDiv.id="slidersDiv";
                document.getElementById("synthSlidersContainer").appendChild(labelsDiv);
                document.getElementById("synthSlidersContainer").appendChild(slidersDiv);
                for(var x=1; x<9; x++){
                    var canvas=document.createElement('canvas');
                    canvas.className="slider"
                    canvas.id="slider"+x
                    canvas.num=x;
                    canvas.currentChannel=x-1;
                    canvas.isSelected=false;
                    canvas.refresh=function(){
                        this.width=parseInt(document.getElementById("slidersDiv").offsetWidth/8);
                        this.height=parseInt(document.getElementById("slidersDiv").offsetHeight*.8);
                        this.setValue(globals.synthSliderValues[globals.selectedPreset-1][this.num-1]);
                    }
                    canvas.updateValue=function(event){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(0, 0, this.width, event.offsetY/this.offsetHeight*this.height ); 
                        var value=255-parseInt(event.offsetY/this.offsetHeight*255);
                        if(value<12){
                            value=0;
                        }
                        for(var y=1;y<9;y++){
                            if(this.num==y){
                                globals.synthSliderValues[globals.selectedPreset-1][y-1]=value;
                            }
                        }
                        console.log('slider updateValue');
                        globals.needToUpdateLedPresets=true;
                    }
                    canvas.onmouseup=function(event){
                        this.isSelected=false;
                    }
                    canvas.onmouseleave=function(event){
                        this.isSelected=false;
                    }
                    canvas.onmousedown=function(event){
                        this.isSelected=true;
                        this.updateValue(event);
                    }
                    canvas.onmousemove=function(event){
                        if(this.isSelected){
                            var ctx = this.getContext("2d");
                            this.updateValue(event);
                        }
                    }
                    canvas.setValue=function(value){
                        var ctx = this.getContext("2d");
                        ctx.clearRect(0, 0, this.width, this.height);
                        ctx.fillStyle = "#222222";
                        ctx.fillRect(0, 0, this.width, parseInt((255-value)/255*this.height) );
                    }
                    canvas.ontouchstart=function(event){
                        this.isSelected=true;
                        event.offsetY=parseInt(event.touches[0].clientY-this.offsetTop);
                        this.updateValue(event);
                    }
                    canvas.ontouchend=function(event){
                        this.isSelected=false;
                    }
                    canvas.ontouchcancel=function(event){
                        this.isSelected=false;
                    }
                    canvas.ontouchmove=function(event){
                        if(this.isSelected){
                            var ctx = this.getContext("2d");
                            eventOffsetY=parseInt(event.touches[0].clientY-this.offsetTop);
                            if(eventOffsetY<0){
                                eventOffsetY=0;
                            }
                            if(eventOffsetY>=this.offsetHeight){
                                eventOffsetX=this.offsetHeight;
                            }  
                            event.offsetY=eventOffsetY;  
                            this.updateValue(event);
                        }
                    }                    
                    slidersDiv.appendChild(canvas);
                    var sliderLabelValues=[
                        'Color',
                        'ColorSpread',
                        'CycleTime',
                        'TrailLength',
                        'TrailSpread',
                        'Direction',
                        'Strobe',
                        'Brightness'
                    ]
                    var label=document.createElement('span');
                    label.className="sliderLabel";
                    label.id="sliderLabel"+x;
                    labelsDiv.appendChild(label)
                    label.innerHTML=sliderLabelValues[canvas.num-1];
                    label.refreshLabel=function(){
                        this.style.lineHeight=parseInt(this.parentNode.offsetHeight*.9)+'px';
                    }
                }
            }

            function makeGetSettingsCall(){
                var urlString='http://'+location.host + '/getSettings'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    var getResponse=JSON.parse(this.response);
                    console.log(JSON.parse(this.response));
                    for (var x in globals.settingsPageFields){
                        document.getElementById(globals.settingsPageFields[x].name).value=getResponse[globals.settingsPageFields[x].name];
                    }
                    makeGetLedPresetsCall();
                }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeUpdateSettingsCall(){
                var payload={};
                for (var x in globals.settingsPageFields){
                    payload[globals.settingsPageFields[x].name]=document.getElementById(globals.settingsPageFields[x].name).value;
                }
                var urlString='http://'+location.host + '/updateSettings'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200){
                        console.log(this.responseText);
                    }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }

            function makeGetLedPresetsCall(){
                var urlString='http://'+location.host + '/getLedPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200){
                        var getResponse=JSON.parse(this.response);
                        console.log(JSON.parse(this.response));
                        for(var x=0;x<5;x++){
                            for(var y=0; y<8; y++){
                                globals.synthSliderValues[x][y]=getResponse["ledPresets"][x][y];
                                document.getElementById('slider'+parseInt(y+1)).setValue(globals.synthSliderValues[x][y]);
                            }
                        }
                        for(var x=0;x<5;x++){
                            if(getResponse["presetTypes"][x]==1){
                                globals.presetTypes[x]="pixel";
                            }else{
                                globals.presetTypes[x]="synth";
                            }
                        }
                        handleSelectedPresetButton(parseInt(getResponse["selectedPreset"]+1),"numberbutton");
                        makeGetPixelMapCall();
                    }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeUpdateLedPresetsCall(){
                globals.presetValueDebounceTime=new Date().getTime();
                var tempPresetTypes=[];
                for(var x=0; x<5;x++){
                    if(globals.presetTypes[x]=="pixel"){
                        tempPresetTypes.push(1);
                    }else{
                        tempPresetTypes.push(0);
                    }
                }
                var payload={"ledPresets":globals.synthSliderValues, "selectedPreset":parseInt(globals.selectedPreset-1), "presetTypes": tempPresetTypes};
                var urlString='http://'+location.host + '/updateLedPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    console.log(this.responseText);
                }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }

            function makeGetPixelMapCall(){
                var urlString='http://'+location.host + '/getPixelMapPresets'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                    if(this.readyState == 4 && this.status == 200){
                        var getResponse=JSON.parse(this.response);
                        console.log(JSON.parse(this.response));
                        for(var x=0;x<5;x++){
                            for(var y=0; y<8;y++){
                                for(var z=0; z<8;z++){
                                    globals.pixelMap[x][y][z]=getResponse["pixelMap"][x][y][z];
                                }
                            }
                        }
                        syncView();
                    }
                };
                xhttp.open('GET', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send();
            }

            function makeUpdatPixelMapCall(){
                var payload={"pixelMap":globals.pixelMap};
                var urlString='http://'+location.host + '/updatePixelMap'
                var xhttp = new XMLHttpRequest(); 
                xhttp.onreadystatechange = function() {
                if(this.readyState == 4 && this.status == 200){
                    console.log(this.responseText);
                }
                };
                xhttp.open('POST', urlString, true);
                xhttp.setRequestHeader('Content-Type', 'application/json')
                xhttp.send(JSON.stringify(payload));
            }

            function initWebSocket(){
                socket = new WebSocket("ws:/" + "/" + location.host + ":81");
                socket.onopen = function(e) {  console.log("[socket] socket.onopen "); };
                socket.onerror = function(e) {
                    console.log("[socket] socket.onerror ");
                    console.log(e);
                    setTimeout(function(){
                        console.log("retrying websocket connection initialization")
                        initWebSocket();
                    },1000);
                };
                socket.onclose = function(e) {
                    console.log("[socket] socket.onerror ");
                    console.log(e);
                    setTimeout(function(){
                        console.log("retrying websocket connection initialization")
                        initWebSocket();
                    },1000);
                };
                socket.onmessage = function(e) {  
                    console.log('Received data from websocket: '+e.data);
                    globals.socketConnectivityCheck=new Date().getTime();
                    var incomingData=e.data.split(',');
                    var incomingPreset=parseInt(incomingData[incomingData.length-1])%5;
                    rotateDataHistoryBuffer([parseFloat(incomingData[0]),parseFloat(incomingData[1]),parseFloat(incomingData[2]),parseFloat(parseInt(incomingData[3])/5)+.05 ]);
                    if( (new Date().getTime()-globals.presetValueDebounceTime) > 2000){
                        if(globals.selectedPreset!=(incomingPreset+1)){
                            globals.selectedPreset=(incomingPreset+1);
                            syncView();
                            console.log('socket change');
                        }
                    }
                    return true;
                };
            }
        
            function initOrientationListener(){
                var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
                processOrientation(orientation);
				window.addEventListener("orientationchange", function() {
                    var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
                    processOrientation(orientation);
				}, false);
				window.addEventListener("resume", function() {
                    var orientation = (screen.orientation || {}).type || screen.mozOrientation || screen.msOrientation;
                    processOrientation(orientation);
				}, false);
			}

            function getPlatformOS() {
                const userAgent = window.navigator.userAgent;
                let os = null;
                const isIOS = (/iPad|iPhone|iPod/.test(userAgent) ||
                (/Mac|Mac OS|MacIntel/gi.test(userAgent) && (navigator.maxTouchPoints > 1 || "ontouchend" in document))) && !window.MSStream;

                if (isIOS) {
                    os = 'iOS';
                } else if (/'Win32|Win64|Windows|Windows NT|WinCE/gi.test(userAgent)) {
                    os = 'Windows';
                } else if (/Android/gi.test(userAgent)) {
                    os = 'Android';
                } else if (/Linux/gi.test(userAgent)) {
                    os = 'Linux';
                }

                return os;
            }

            function processOrientation(orientation){
                console.log(orientation+" "+getPlatformOS())
                if (orientation.indexOf("portrait")!=-1 && (getPlatformOS()=='iOS' || getPlatformOS()=='Android' )) {
                    if(document.fullscreenElement==null){
                        document.getElementById("selectedPresetContainer").style.marginTop='50px';
                        document.getElementById("selectedPresetContainer").style.marginBottom='';
                        document.getElementById("selectedPresetContainer").style.height='40%';
                        document.getElementById("pixelMapContainer").style.marginBottom='110px';
                        document.getElementById("colorPickerContainer").style.height='70%';
                    }else{
                        document.getElementById("selectedPresetContainer").style.marginTop='0px';
                        document.getElementById("selectedPresetContainer").style.marginBottom='';
                        document.getElementById("selectedPresetContainer").style.height='60%';
                        document.getElementById("pixelMapContainer").style.marginBottom='50px';
                        document.getElementById("colorPickerContainer").style.height='70%';
                    }
                }else if(orientation.indexOf("landscape")!=-1 && (getPlatformOS()=='iOS' || getPlatformOS()=='Android' )){
                    document.getElementById("selectedPresetContainer").style.marginTop='-16px';
                    document.getElementById("selectedPresetContainer").style.marginBottom='10px';
                    document.getElementById("selectedPresetContainer").style.height='';
                    document.getElementById("pixelMapContainer").style.marginBottom='10px';
                    document.getElementById("colorPickerContainer").style.height='100%';
                }else{
                    document.getElementById("selectedPresetContainer").style.marginTop='';
                    document.getElementById("selectedPresetContainer").style.marginBottom='';
                    document.getElementById("selectedPresetContainer").style.height='';
                    document.getElementById("pixelMapContainer").style.marginBottom='';
                    document.getElementById("colorPickerContainer").style.height='';                   
                }
            }

        </script>
    </body>
</html>
